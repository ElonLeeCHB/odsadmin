2025-10-23

  📋 下一步

  1. ✅ 路由已设定完成
  2. ⏳ 需要测试 GivemeTestController 的完整流程
  3. ⏳ 确认资料库有测试发票资料
  4. ⏳ 开发正式环境的 GivemeController

  --------

# 發票串接系統 - 技術文件

> **📋 測試環境帳密**
> 統編: `53418005` | 證號: `Giveme09` | 密碼: `9VHGCq`
> ⚠️ 使用前請確認伺服器 IP 已加入白名單

---

## 一、現有系統架構

### 1.1 資料表結構

#### 核心資料表

| 資料表 | 說明 | 備註 |
|--------|------|------|
| `invoices` | 發票主表 | 儲存發票主要資訊 |
| `invoice_items` | 發票項目表 | 儲存發票商品明細（可自訂名稱） |
| `invoice_carrier_types` | 載具類型表 | 載具類型查詢表（10種載具） |
| `invoice_order_maps` | 發票訂單對應表 | 多對多關聯 |
| `order_groups` | 發票群組表 | 支援複雜開票情境 |
| `orders` | 訂單表 | 關聯 order_group_id |
| `order_products` | 訂單商品表 | 訂單原始商品資料 |

#### 資料表關聯圖

```
orders (訂單) ←─────────┐
  └─ order_products      │  訂單與發票的關聯
                         │  (本系統內部處理)
invoices (發票) ←────────┘
  ├─ invoice_items (發票項目) - 可自訂項目名稱
  ├─ invoice_carrier_types (載具類型) - FK: carrier_type
  └─ invoice_order_maps (多對多關聯)
  └─ order_groups (群組開票) - orders.order_group.id, invoices.order_group

Giveme API ←───────────── invoices (發票開立、作廢、查詢)
                         (不處理訂單，只處理發票)
```

### 1.2 系統架構分層

#### 1. 訂單與發票對應（本系統內部）
- 透過 `invoice_order_maps` 處理訂單與發票的關聯
- 支援標準、拆單、合併、群組開票等情境
- **與 Giveme API 無關**

#### 2. Giveme 發票處理（純發票操作）
- 開立發票（B2C / B2B）
- 作廢發票
- 查詢發票
- 列印發票
- **與訂單無關，只處理發票資料**

### 1.3 發票作業流程（兩階段設計）

本系統的發票作業分為**兩個獨立階段**：

#### 📝 階段一：發票內容建立（本地資料庫操作）

**目的**：在本系統資料庫中準備發票資料

**操作內容**：
- 建立 `invoices` 記錄（買方、賣方、金額、載具等）
- 建立 `invoice_items` 記錄（商品明細、可自訂品項名稱）
- 關聯訂單（透過 `invoice_order_maps`）

**對應 API**：
- `InvoiceController` - 發票 CRUD
- `InvoiceItemController` - 商品明細 CRUD

**前端操作**：
- 新增/編輯發票內容
- 設定商品項目
- 設定買方資訊、載具、統編
- **此階段與機迷坊無關，純本地操作**

#### 🚀 階段二：發票開立（串接機迷坊）

**目的**：將本地發票資料送至機迷坊開立正式發票

**操作流程**：
```
前端傳送 → { invoice_id, order_id, order_code }
     ↓
後端處理：
  1. 從資料庫查詢 invoices (id = invoice_id)
  2. 從資料庫查詢 invoice_items (invoice_id = invoice_id)
  3. 組裝成機迷坊 API 格式
  4. 呼叫機迷坊 API (addB2C/addB2B)
  5. 取得正式發票號碼
  6. 更新本地資料庫（invoice_number, api_response_data）
```

**重要原則**：
- ✅ 前端**只傳 ID**：`invoice_id`, `order_id`, `order_code`
- ✅ 後端從資料庫讀取所有發票內容（金額、商品、買方等）
- ❌ 前端**不傳**金額、商品、買方等詳細資料
- 📌 **原因**：避免前端與資料庫資料不一致，確保單一資料來源

### 1.4 開票情境

本系統為服務客戶需求，支援以下開票模式：

| 模式 | 說明 | 範例 |
|------|------|------|
| **標準** | 一張訂單對一張發票 | 1 訂單 → 1 發票 |
| **拆單** | 一張訂單開多張發票 | 1 訂單 → N 發票 |
| **合併** | 多張訂單合開一張發票 | N 訂單 → 1 發票 |
| **群組開票** | n張訂單開m張發票 | 建立 order_group，包含 2 訂單 + 3 發票 |

### 1.5 Controller 架構說明

本系統將發票相關 Controller 分為**三種類型**：

#### 類型一：發票內容管理（階段一）

**目的**：管理本地資料庫的發票資料

| Controller | 說明 | 操作 |
|-----------|------|------|
| `InvoiceController` | 發票 CRUD | 建立、查詢、修改、刪除發票 |
| `InvoiceItemController` | 發票項目 CRUD | 管理發票商品明細 |
| `OrderGroupController` | 訂單群組管理 | 處理群組開票情境 |

**前端傳送資料**：完整的發票內容（金額、商品、買方等）
**資料庫操作**：INSERT/UPDATE/DELETE

#### 類型二：發票開立測試（階段二 - 測試用）

**目的**：測試機迷坊 API 串接功能

| Controller | 說明 | 使用場景 | 資料來源 |
|-----------|------|---------|---------|
| `GivemeDataTestController` | 直接測試 API | 開發測試 | 前端直接傳入完整資料 |
| `GivemeTestController` | 模擬正式流程 | 功能測試 | 從資料庫讀取 (by invoice_id) |

**差異說明**：

**`GivemeDataTestController`**：
- 用途：測試機迷坊 API 是否正常
- 前端傳送：完整的發票資料（金額、商品、買方等）
- 後端處理：直接轉送給機迷坊 API
- 資料庫操作：無（不寫入資料庫）
- 使用時機：開發階段測試 API 連線

**`GivemeTestController`**：
- 用途：測試完整的正式流程
- 前端傳送：`invoice_id`, `order_id`, `order_code`
- 後端處理：從資料庫讀取 → 轉換格式 → 呼叫機迷坊 API → 更新資料庫
- 資料庫操作：SELECT + UPDATE
- 使用時機：功能測試、UAT 測試

**共同點**：
- ✅ 都使用機迷坊測試帳號
- ✅ 都可以真正開立測試發票

#### 類型三：發票開立正式（階段二 - 正式環境）

**目的**：正式環境開立發票

| Controller | 說明 | 使用帳號 |
|-----------|------|---------|
| `GivemeController` | 正式發票開立 | 正式環境帳號 |

**流程與 `GivemeTestController` 相同**：
- 前端傳送：`invoice_id`, `order_id`, `order_code`
- 後端處理：從資料庫讀取 → 轉換格式 → 呼叫機迷坊 API → 更新資料庫
- 差異：使用正式環境帳號（`config('invoice.giveme.*')`）

#### Controller 對應表

| Controller | 環境 | 帳號來源 | 前端傳送 | 資料庫操作 | 用途 |
|-----------|-----|---------|---------|-----------|------|
| `InvoiceController` | - | - | 完整發票資料 | INSERT/UPDATE | 發票內容管理 |
| `GivemeDataTestController` | 測試 | `config('invoice.test.*')` | 完整發票資料 | 無 | API 連線測試 |
| `GivemeTestController` | 測試 | `config('invoice.test.*')` | invoice_id 等 | SELECT + UPDATE | 完整流程測試 |
| `GivemeController` | 正式 | `config('invoice.giveme.*')` | invoice_id 等 | SELECT + UPDATE | 正式發票開立 |

---

## 二、資料表結構分析

### 2.1 invoices 表（發票主表）

#### 現有欄位

| 欄位 | 類型 | NULL | 說明 |
|------|------|------|------|
| `id` | bigint unsigned | NO | 主鍵，自增 |
| `order_group_id` | bigint unsigned | YES | 關聯群組（支援群組開票） |
| `invoice_number` | varchar(255) | NO | 發票號碼（UNIQUE） |
| `invoice_date` | date | NO | 發票日期 |
| `buyer_name` | varchar(255) | YES | 買方名稱（B2C個人/B2B公司） |
| `seller_name` | varchar(255) | YES | 賣方名稱 |
| `tax_id_number` | varchar(20) | YES | 統一編號（買方） |
| `customer_id` | bigint unsigned | YES | 客戶ID |
| `tax_type` | enum | YES | `taxable`, `exempt`, `zero_rate` |
| `tax_amount` | int | NO | 稅額（預設 0） |
| `total_amount` | int | NO | 總金額 |
| `status` | enum | YES | `unpaid`, `paid`, `canceled` |
| `creator_id` | bigint unsigned | YES | 建立者 |
| `modifier_id` | bigint unsigned | YES | 修改者 |
| `created_at` | timestamp | YES | 建立時間 |
| `updated_at` | timestamp | YES | 更新時間 |

#### 💡 欄位命名說明

**為何使用 `buyer_name` 而非 `customer_name`？**

| 資料表 | 欄位 | 用途 |
|--------|------|------|
| `orders` | `customer_name` | 會員姓名（訂單層級） |
| `invoices` | `buyer_name` | 買方名稱（發票層級） |

**buyer_name 的用途**：
- **B2C**：個人姓名（可能與訂單 customer_name 相同或不同）
- **B2B**：公司名稱（與個人無關）
- 對應 Giveme API 的 `customerName` 參數

這樣命名可避免與訂單表的 `customer_name` 混淆。

#### 串接欄位說明

以下欄位用於支援 Giveme API 串接功能：

| 欄位名稱 | 資料類型 | NULL | 預設值 | 說明 | 適用情境 |
|---------|---------|------|--------|------|---------|
| **發票基本資訊** |
| `random_code` | varchar(4) | YES | NULL | 4位隨機碼（Giveme API 回傳） | B2C |
| `content` | text | YES | NULL | 總備註（顯示於發票上） | 全部 |
| `email` | varchar(255) | YES | NULL | 客戶 Email | 全部 |
| **載具資訊** |
| `carrier_type` | enum(10種) | NO | 'none' | 載具類型 | B2C |
| `carrier_number` | varchar(255) | YES | NULL | 載具號碼/條碼 | B2C |
| `donation_code` | varchar(20) | YES | NULL | 捐贈碼 | B2C 捐贈 |
| **B2B 專用欄位** |
| `tax_state` | tinyint(1) | NO | 0 | 單價是否含稅（0-含稅, 1-未稅） | B2B |
| `net_amount` | int | YES | NULL | 未稅金額（淨額） | B2B |
| **零稅率專用** |
| `customs_mark` | enum('0','1') | YES | NULL | 通關方式（0-非海關, 1-經海關） | 零稅率 |
| `zero_remark` | varchar(2) | YES | NULL | 零稅率原因代碼（71-79） | 零稅率 |
| **混合稅專用** |
| `free_amount` | int | YES | NULL | 免稅銷售額合計 | 混合稅 |
| `zero_amount` | int | YES | NULL | 零稅率銷售額合計 | 混合稅 |
| **API 串接記錄** |
| `api_request_data` | json | YES | NULL | 呼叫 Giveme API 的請求資料 | 全部 |
| `api_response_data` | json | YES | NULL | Giveme API 的回應資料 | 全部 |
| `api_error` | text | YES | NULL | API 錯誤訊息 | 全部 |
| **作廢資訊** |
| `canceled_at` | timestamp | YES | NULL | 作廢時間 | 作廢時 |
| `cancel_reason` | text | YES | NULL | 作廢原因 | 作廢時 |
| `giveme_status` | enum('0','1') | NO | '0' | Giveme 發票狀態（0-正常, 1-作廢） | 全部 |

#### 📋 carrier_type 載具類型定義

```sql
carrier_type ENUM(
    'none',           -- 無載具（列印紙本）
    'phone_barcode',  -- 手機條碼
    'citizen_cert',   -- 自然人憑證
    'member_card',    -- 會員卡
    'credit_card',    -- 信用卡載具
    'icash',          -- icash
    'easycard',       -- 悠遊卡
    'ipass',          -- 一卡通
    'email',          -- 電子郵件載具（跨境電商）
    'donation'        -- 捐贈
) DEFAULT 'none'
```

#### 🎫 載具類型說明

**財政部載具分類**（本系統不處理分類，僅供理解）：

1. **共通性載具**（具唯一性，一人一個）
   - 手機條碼（`phone_barcode`）
   - 自然人憑證（`citizen_cert`）

2. **非共通性載具**（一人可有多個）
   - 會員卡、信用卡、icash、悠遊卡、一卡通、電子郵件等

3. **載具歸戶**：可將非共通性載具歸到共通性載具（在財政部系統處理，非本系統功能）

**本系統設計**：所有載具類型並列，不區分共通性/非共通性。

#### 載具類型對應表

| carrier_type | 中文名稱 | carrier_number 範例 | Giveme API 對應 |
|-------------|---------|-------------------|----------------|
| `none` | 無載具（紙本） | NULL | 不傳 phone/orderCode |
| `phone_barcode` | 手機條碼 | `/ABC1234` | `phone` = `/ABC1234` |
| `citizen_cert` | 自然人憑證 | `AA12345678` | `orderCode` = `AA12345678` |
| `member_card` | 會員卡 | `M123456` | `orderCode` = `M123456` |
| `credit_card` | 信用卡載具 | `CC1234567890` | `orderCode` = `CC1234567890` |
| `icash` | icash | `IC1234567890` | `orderCode` = `IC1234567890` |
| `easycard` | 悠遊卡 | `EC1234567890` | `orderCode` = `EC1234567890` |
| `ipass` | 一卡通 | `IP1234567890` | `orderCode` = `IP1234567890` |
| `email` | 電子郵件 | `user@example.com` | `orderCode` = `user@example.com` |
| `donation` | 捐贈 | NULL | `state=1` + `donationCode` |

**手機條碼格式規則**：
- 第 1 碼為 `/`
- 其餘 7 碼由數字 `0-9`、大寫英文 `A-Z`、特殊符號 `+`, `-`, `.` 組成
- 範例：`/ABC1234`, `/1234567`, `/AB+CD-E`

#### tax_type 課稅類型

`tax_type` 欄位支援 5 種課稅類型：

```sql
tax_type ENUM('taxable','exempt','zero_rate','mixed','special')
```

| 類型 | 說明 |
|------|------|
| `taxable` | 應稅 |
| `exempt` | 免稅 |
| `zero_rate` | 零稅率 |
| `mixed` | 混合稅 |
| `special` | 特種稅 |

#### 💡 設計說明

**移除 invoice_type 欄位的理由**：
- 透過 `tax_id_number` 有無即可判斷 B2C/B2B
- 避免資料冗余和不一致
- 可在 Model 中使用 Accessor 提供動態屬性

```php
// Model 中動態判斷
public function getInvoiceTypeAttribute(): string
{
    return !empty($this->tax_id_number) ? 'B2B' : 'B2C';
}

public function isB2B(): bool
{
    return !empty($this->tax_id_number);
}
```

**金額關係公式**：
```
tax_amount + net_amount = total_amount
稅額 + 未稅金額 = 總金額
```

**範例**：
- 未稅金額（net_amount）= 500
- 稅額（tax_amount）= 25
- 總金額（total_amount）= 525

---

### 2.2 invoice_items 表（發票項目表）

#### 現有欄位

| 欄位 | 類型 | NULL | 說明 |
|------|------|------|------|
| `id` | bigint unsigned | NO | 主鍵，自增 |
| `invoice_id` | bigint unsigned | NO | 發票ID |
| `sort_order` | tinyint unsigned | NO | 排序（預設 0） |
| `name` | varchar(255) | NO | 商品名稱（**可自訂**） |
| `is_tax_included` | tinyint(1) | NO | 是否含稅（預設 1） |
| `quantity` | decimal(12,3) | NO | 數量（預設 1.000） |
| `price` | decimal(12,3) | NO | 單價 |
| `subtotal` | decimal(12,3) | NO | 小計 |

#### 串接欄位說明

以下欄位用於支援 Giveme API 串接功能：

| 欄位名稱 | 資料類型 | NULL | 預設值 | 說明 | 適用情境 |
|---------|---------|------|--------|------|---------|
| `remark` | varchar(255) | YES | NULL | 商品備註 | 全部 |
| `item_tax_type` | enum('0','1','2') | YES | NULL | 商品課稅類型（0-應稅, 1-零稅率, 2-免稅） | 混合稅必填 |

---

### 2.3 invoice_carrier_types 表（載具類型查詢表）

#### 資料表結構

| 欄位 | 類型 | NULL | 說明 |
|------|------|------|------|
| `id` | bigint unsigned | NO | 主鍵，自增 |
| `code` | varchar(20) | NO | 載具代碼（UNIQUE），對應 invoices.carrier_type |
| `name` | varchar(50) | NO | 中文名稱 |
| `description` | varchar(255) | YES | 說明 |
| `giveme_param` | varchar(20) | YES | 對應 Giveme API 參數名稱（phone/orderCode/donationCode） |
| `sort_order` | tinyint unsigned | NO | 排序（預設 0） |
| `is_active` | tinyint(1) | NO | 是否啟用（預設 1） |
| `created_at` | timestamp | YES | 建立時間 |
| `updated_at` | timestamp | YES | 更新時間 |

#### 預設載具類型資料

Migration 會自動插入 10 種載具類型：

| code | name | giveme_param | sort_order |
|------|------|--------------|------------|
| `none` | 無載具（列印紙本） | `null` | 1 |
| `phone_barcode` | 手機條碼 | `phone` | 2 |
| `citizen_cert` | 自然人憑證 | `orderCode` | 3 |
| `member_card` | 會員卡 | `orderCode` | 4 |
| `credit_card` | 信用卡載具 | `orderCode` | 5 |
| `icash` | icash | `orderCode` | 6 |
| `easycard` | 悠遊卡 | `orderCode` | 7 |
| `ipass` | 一卡通 | `orderCode` | 8 |
| `email` | 電子郵件載具 | `orderCode` | 9 |
| `donation` | 捐贈 | `donationCode` | 10 |

#### 使用說明

此表提供：
1. **前端下拉選單資料來源** - 讓使用者選擇載具類型
2. **API 參數對應** - `giveme_param` 欄位指示該載具類型對應到 Giveme API 的哪個參數
3. **管理彈性** - 可透過 `is_active` 控制是否顯示特定載具類型

---

### 2.4 其他資料表（✅ 無需修改）

- ✅ **invoice_order_maps** - 結構完整，已滿足需求
- ✅ **order_groups** - 結構完整，已滿足需求
- ✅ **order_products** - 僅作為來源資料，不需修改

---

## 三、Giveme API 串接功能

### 3.1 核心功能

本系統已串接 Giveme 廠商 API，可取得真實發票號碼並進行發票管理。

### 3.2 功能清單

| 功能 | API Action | HTTP | URL | 狀態 |
|------|------------|------|-----|------|
| B2C 發票開立 | `addB2C` | POST | `/invoice.do?action=addB2C` | ✅ 已完成 |
| B2B 發票開立 | `addB2B` | POST | `/invoice.do?action=addB2B` | ✅ 已完成 |
| 發票作廢 | `cancelInvoice` | POST | `/invoice.do?action=cancelInvoice` | ✅ 已完成 |
| 發票查詢 | `query` | POST | `/invoice.do?action=query` | ✅ 已完成 |
| 發票列印（網頁） | `invoicePrint` | GET | `/invoice.do?action=invoicePrint` | ✅ 已完成 |
| 發票列印（圖片） | `picture` | POST | `/invoice.do?action=picture` | ✅ 已完成 |

### 3.3 系統架構

#### Service 層

```
app\Domains\ApiPosV2\Services\Invoice\
├── GivemeInvoiceService.php      # 主要服務類
├── InvoiceSignature.php          # 簽名產生器
├── InvoiceValidator.php          # 參數驗證器
└── InvoiceFormatter.php          # 格式轉換器
```

#### Controller 層

```
app\Domains\ApiPosV2\Http\Controllers\Sale\InvoiceIssue\
├── GivemeDataTestController.php  # API 連線測試（直接傳資料）
├── GivemeTestController.php      # 完整流程測試（從資料庫讀取）
└── GivemeController.php          # 正式發票開立
```

**說明**：
- `GivemeDataTestController`：原 `InvoiceGivemeTestController`，用於 API 直接測試
- `GivemeTestController`：新建，正式流程的測試版（使用測試帳號）
- `GivemeController`：正式環境（使用正式帳號）

### 3.4 實作架構

系統採用分層架構實現 Giveme API 串接：

1. **資料表** - 透過 Migration 建立完整的發票資料結構
2. **Model 層** - Invoice 和 InvoiceItem Model 提供資料存取
3. **Service 層** - GivemeInvoiceService 處理 API 串接邏輯
4. **Controller 層** - 提供 RESTful API 介面
5. **測試** - 支援 Postman 和 Controller 測試

---

## 四、實現狀態

### ✅ 資料庫層

- [x] 分析現有資料表結構
- [x] 對比 Giveme API 需求
- [x] 設計發票串接欄位
- [x] 建立 Migration 檔案（invoices 表擴充）
- [x] 建立 invoice_carrier_types 資料表
- [x] 定義完整載具類型（10種）
- [x] 支援 5 種課稅類型

### ✅ API 串接層

- [x] 實作 GivemeInvoiceService
- [x] 實作簽名機制（MD5 加密）
- [x] 完成 B2C 發票開立
- [x] 完成 B2B 發票開立
- [x] 完成發票作廢
- [x] 完成發票查詢
- [x] 完成發票列印（網頁/圖片）
- [x] GivemeDataTestController 測試通過（API 直接測試）
- [ ] GivemeTestController 開發中（完整流程測試）
- [ ] GivemeController 待開發（正式環境）

### 📋 後續優化

- [ ] 完成 GivemeTestController 開發
- [ ] 完成 GivemeController 開發
- [ ] 更新 Model 類別（加入關聯和輔助方法）
- [ ] 開發後台管理介面
- [ ] 撰寫單元測試
- [ ] 建立自動化測試案例
- [ ] 完善錯誤處理和日誌記錄

---

## 五、技術注意事項

### 5.1 資料表結構說明

本系統的發票資料表已完成 Giveme API 串接所需的欄位擴充：

- `invoices` 表新增 18 個欄位，全部設為 `nullable()`，確保與現有資料相容
- `invoice_items` 表新增 2 個欄位（`remark` 和 `item_tax_type`）
- `invoice_carrier_types` 表包含 10 種預設載具類型
- Migration 執行時已考慮資料庫相容性

### 5.2 欄位對應表

#### invoices 欄位對應 Giveme API

| 本系統欄位 | Giveme API 參數 | B2C | B2B | 說明 |
|-----------|----------------|-----|-----|------|
| `invoice_number` | `code` | ✓ | ✓ | 發票號碼（API回傳） |
| `invoice_date` | `datetime` | ✓ | ✓ | 發票日期 |
| `random_code` | `randomCode` | ✓ | - | 4位隨機碼（API回傳） |
| `content` | `content` | ✓ | ✓ | 總備註 |
| `buyer_name` | `customerName` | ✓ | ✓ | 買方名稱（個人/公司） |
| `email` | `email` | ✓ | ✓ | 客戶 Email |
| `tax_id_number` | `phone` (B2B) | - | ✓ | 買方統編 |
| `carrier_type` + `carrier_number` | `phone` / `orderCode` | ✓ | - | 載具（依類型判斷） |
| `donation_code` | `donationCode` | ✓ | - | 捐贈碼 |
| `tax_state` | `taxState` | - | ✓ | 單價是否含稅 |
| `net_amount` | `sales` | - | ✓ | 未稅金額 |
| `tax_amount` | `amount` | ✓ | ✓ | 稅額 |
| `total_amount` | `totalFee` | ✓ | ✓ | 總金額（net_amount + tax_amount） |
| `tax_type` | `taxType` | ✓ | ✓ | 課稅類型 |
| `customs_mark` | `customsMark` | ✓ | ✓ | 通關方式（零稅率） |
| `zero_remark` | `zeroRemark` | ✓ | ✓ | 零稅率原因 |
| `api_request_data` | - | ✓ | ✓ | 記錄請求 JSON |
| `api_response_data` | - | ✓ | ✓ | 記錄回應 JSON |
| `giveme_status` | `status` | ✓ | ✓ | Giveme 發票狀態 |

#### 載具參數對應邏輯

```php
// Service 層處理
switch ($invoice->carrier_type) {
    case 'donation':
        $data['state'] = '1';
        $data['donationCode'] = $invoice->donation_code;
        break;

    case 'phone_barcode':
        $data['state'] = '0';
        $data['phone'] = $invoice->carrier_number; // 手機條碼 → phone
        break;

    case 'citizen_cert':
    case 'member_card':
    case 'credit_card':
    case 'icash':
    case 'easycard':
    case 'ipass':
    case 'email':
        $data['state'] = '0';
        $data['orderCode'] = $invoice->carrier_number; // 其他 → orderCode
        break;

    case 'none':
    default:
        $data['state'] = '0';
        // 不傳 phone 和 orderCode（列印紙本）
        break;
}
```

#### invoice_items 欄位對應 Giveme API

| 本系統欄位 | Giveme API 參數 | 說明 |
|-----------|----------------|------|
| `name` | `items[].name` | 商品名稱 |
| `price` | `items[].money` | 單價 |
| `quantity` | `items[].number` | 數量 |
| `subtotal` | 計算值 | price × quantity |
| `remark` | `items[].remark` | 商品備註 |
| `item_tax_type` | `items[].taxType` | 商品課稅類型（混合稅） |

---

## 六、環境設定

### 6.1 .env 設定

#### 測試環境（TEST）

```env
# Giveme 電子發票 API - 測試環境
GIVEME_INVOICE_API_URL=https://www.giveme.com.tw/invoice.do
GIVEME_INVOICE_TEST_TAX_ID=53418005     # 測試統編
GIVEME_INVOICE_TEST_ACCOUNT=Giveme09    # 測試帳號
GIVEME_INVOICE_TEST_PASSWORD=9VHGCq     # 測試密碼
```

#### 正式環境（PRODUCTION）

```env
# Giveme 電子發票 API - 正式環境
GIVEME_INVOICE_API_URL=https://www.giveme.com.tw/invoice.do
GIVEME_INVOICE_TAX_ID=your_company_tax_id      # 貴公司統一編號
GIVEME_INVOICE_ACCOUNT=your_api_account        # API 帳號
GIVEME_INVOICE_PASSWORD=your_api_password      # API 密碼
```

### 6.2 Config 設定

系統已建立 `config/invoice.php` 設定檔：

```php
<?php

return [
    'giveme' => [
        'api_url' => env('GIVEME_INVOICE_API_URL', 'https://www.giveme.com.tw/invoice.do'),
        'tax_id' => env('GIVEME_INVOICE_TAX_ID'),
        'account' => env('GIVEME_INVOICE_ACCOUNT'),
        'password' => env('GIVEME_INVOICE_PASSWORD'),
    ],

    'test' => [
        'tax_id' => env('GIVEME_INVOICE_TEST_TAX_ID', '53418005'),
        'account' => env('GIVEME_INVOICE_TEST_ACCOUNT', 'Giveme09'),
        'password' => env('GIVEME_INVOICE_TEST_PASSWORD', '9VHGCq'),
    ],
];
```

---

## 七、結論

### 現有資料表評估

| 項目 | 評估結果 |
|------|---------|
| **基礎架構** | ✅ 完整，支援多種開票情境 |
| **訂單關聯** | ✅ 完整，透過 invoice_order_maps 多對多 |
| **群組開票** | ✅ 完整，透過 order_groups 支援 |
| **架構分層** | ✅ 訂單關聯與發票API分離清晰 |
| **Giveme API 欄位** | ✅ 已新增 18 個欄位（migration 已完成） |
| **商品明細** | ✅ 已新增 2 個欄位（remark, item_tax_type） |
| **載具類型** | ✅ 已建立 invoice_carrier_types 表（10種載具） |

### 總結

現有資料表架構設計良好，**已完成資料庫結構準備**：

✅ **已完成項目**：
1. **新增欄位** - invoices 表已新增 18 個欄位以支援 Giveme API
2. **修改 tax_type** - 已擴充為 5 種（taxable, exempt, zero_rate, mixed, special）
3. **新增載具類型表** - invoice_carrier_types 表（10 種類型，含預設資料）
4. **invoice_items 擴充** - 已新增 remark 和 item_tax_type 欄位

⏳ **待處理項目**：
1. **更新 Model 類別** - Invoice, InvoiceItem, InvoiceCarrierType
2. **開發 Service 層** - GivemeInvoiceService 進行 API 串接
3. **開發 Controller** - InvoiceGivemeController
4. **撰寫測試案例**

### 金額欄位設計

| 欄位 | 說明 | 公式 |
|------|------|------|
| `net_amount` | 未稅金額（淨額） | - |
| `tax_amount` | 稅額 | - |
| `total_amount` | 總金額 | `tax_amount + net_amount` |

### 設計優化

✅ **已移除冗余欄位**：
- `invoice_type` - 透過 tax_id_number 判斷 B2C/B2B

✅ **清晰的架構分層**：
- 訂單與發票關聯 → 本系統內部處理
- Giveme 發票操作 → 純發票 API，不涉及訂單

---

**文件版本**：3.2
**撰寫日期**：2025-10-23
**撰寫者**：Claude Code
**變更記錄**：
- v3.2: 加入測試環境帳密資料，更新所有 API 請求範例
- v3.1: 完成 Migration 開發，建立 invoice_carrier_types 資料表
- v3.0: 移除冗余欄位、定義完整載具類型、釐清架構分層
- v2.0: 新增資料表結構分析、欄位對應表
- v1.0: 初始版本，根據 Giveme API 5.0 文檔整理

---

# Giveme 電子發票 API 串接文件

## 文件版本
- **API 版本**: 5.0
- **供應商**: Giveme 電子發票加值中心
- **文檔位置**: `docs/API文檔-Giveme電子發票加值中心.pdf`
- **最後更新**: 2025-10-22

---

## 目錄
1. [系統概述](#系統概述)
2. [認證機制](#認證機制)
3. [環境設定](#環境設定)
4. [API 接口列表](#api-接口列表)
5. [B2C 發票開立](#b2c-發票開立)
6. [B2B 發票開立](#b2b-發票開立)
7. [發票作廢](#發票作廢)
8. [發票查詢](#發票查詢)
9. [發票列印](#發票列印)
10. [錯誤處理](#錯誤處理)
11. [測試流程](#測試流程)

---

## 系統概述

### 供應商資訊
- **名稱**: Giveme 電子發票加值中心
- **Line 客服**: @giveme
- **API 基礎網址**: `https://www.giveme.com.tw/invoice.do`

### 功能特點
- 支援 B2C（一般消費者）發票開立
- 支援 B2B（公司行號）發票開立
- 支援發票作廢
- 支援電子載具（手機條碼、會員載具）
- 支援發票捐贈
- 支援雲列印（需選購雲發票機）
- 支援多種課稅類型（應稅、零稅率、免稅、混合稅）

---

## 認證機制

### 簽名算法 (sign)

**公式**：
```
sign = MD5(timeStamp + idno + password).toUpperCase()
```

**參數說明**：
- `timeStamp`: 當前時間毫秒數（必須在 5 分鐘內有效）
- `idno`: API 帳號
- `password`: API 登錄密碼

**PHP 範例**：
```php
$timeStamp = round(microtime(true) * 1000); // 毫秒時間戳
$idno = 'Giveme09';  // 測試證號
$password = '9VHGCq';  // 測試密碼
$sign = strtoupper(md5($timeStamp . $idno . $password));

// 範例輸出
// $timeStamp = 1729696800000
// $sign = "A1B2C3D4E5F6G7H8I9J0K1L2M3N4O5P6" (實際會不同)
```

**測試簽名算法**：
```php
// 測試環境參數
$timeStamp = 1729696800000;  // 固定時間戳用於測試
$idno = 'Giveme09';
$password = '9VHGCq';
$sign = strtoupper(md5($timeStamp . $idno . $password));

echo "簽名字串: {$timeStamp}{$idno}{$password}\n";
echo "MD5 結果: " . md5($timeStamp . $idno . $password) . "\n";
echo "轉大寫後: {$sign}\n";
```

**注意事項**：
1. 時間戳必須使用**毫秒**（13位數字）
2. MD5 結果必須轉為**大寫**
3. 簽名有效期為 **5 分鐘**
4. 簽名錯誤會導致 API 調用失敗

---

## 環境設定

### 後台設定步驟

#### 1. 新增 API 帳號
**位置**：系統設定 → 員工設定 → 新增 API 帳號

**要求**：
- API 帳號密碼請**複雜化**
- 建議使用強密碼（大小寫英文 + 數字 + 特殊符號）

#### 2. 設定白名單 IP
**位置**：系統設定 → 白名單設定

**要求**：
- 必須輸入貴司**固定 IP**
- 僅白名單內的 IP 可調用 API

### 環境變數設定

#### 測試環境設定

建議在 `.env` 中加入測試環境參數：

```env
# Giveme 電子發票 API - 測試環境
GIVEME_INVOICE_API_URL=https://www.giveme.com.tw/invoice.do
GIVEME_INVOICE_TEST_TAX_ID=53418005     # 測試統編
GIVEME_INVOICE_TEST_ACCOUNT=Giveme09    # 測試證號
GIVEME_INVOICE_TEST_PASSWORD=9VHGCq     # 測試密碼
```

**測試環境資訊**：
- 統編 (tax_id): `53418005`
- 帳號 (account): `Giveme09`
- 密碼 (password): `9VHGCq`

#### 正式環境設定

正式環境請聯繫 Giveme Line 客服 `@giveme` 取得正式帳號：

```env
# Giveme 電子發票 API - 正式環境
GIVEME_INVOICE_API_URL=https://www.giveme.com.tw/invoice.do
GIVEME_INVOICE_TAX_ID=your_company_tax_id      # 貴公司統一編號
GIVEME_INVOICE_ACCOUNT=your_api_account        # API 帳號
GIVEME_INVOICE_PASSWORD=your_api_password      # API 密碼
```

### Config 設定

建議新增 `config/invoice.php`：

```php
<?php

return [
    'giveme' => [
        'api_url' => env('GIVEME_INVOICE_API_URL', 'https://www.giveme.com.tw/invoice.do'),
        'tax_id' => env('GIVEME_INVOICE_TAX_ID'),
        'account' => env('GIVEME_INVOICE_ACCOUNT'),
        'password' => env('GIVEME_INVOICE_PASSWORD'),
    ],

    'test' => [
        'tax_id' => env('GIVEME_INVOICE_TEST_TAX_ID', '53418005'),
        'account' => env('GIVEME_INVOICE_TEST_ACCOUNT', 'Giveme09'),
        'password' => env('GIVEME_INVOICE_TEST_PASSWORD', '9VHGCq'),
    ],
];
```

---

## API 接口列表

| 功能 | Action | Method | 說明 |
|------|--------|--------|------|
| B2C 發票新增 | `addB2C` | POST | 開立一般消費者發票 |
| B2B 發票新增 | `addB2B` | POST | 開立公司行號發票 |
| 發票作廢 | `cancelInvoice` | POST | 作廢已開立發票 |
| 發票查詢 | `query` | POST | 查詢發票資訊 |
| 發票列印 | `invoicePrint` | GET | 列印發票 |
| 發票圖片列印 | `picture` | POST | 取得發票圖片 |

**完整 URL 格式**：
```
https://www.giveme.com.tw/invoice.do?action={action}
```

---

## B2C 發票開立

### API 資訊
- **Action**: `addB2C`
- **Method**: `POST`
- **URL**: `https://www.giveme.com.tw/invoice.do?action=addB2C`
- **Content-Type**: `application/json`

### 請求參數

#### 基本參數（必填）

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `timeStamp` | string | ✓ | 當前時間毫秒數（5分鐘內有效） |
| `uncode` | string | ✓ | 貴公司統一編號 |
| `idno` | string | ✓ | API 帳號 |
| `sign` | string | ✓ | 簽名（MD5 加密） |

#### 發票資訊參數

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `datetime` | string | ✓ | 發票日期 `yyyy-MM-dd` 或電腦時間毫秒數 |
| `totalFee` | string/int | ✓ | 總金額（不可為 0，需大於等於 1） |
| `content` | string | ✓ | 總備註（顯示於網頁及發票上） |
| `customerName` | string |  | 買方名稱（選填） |
| `email` | string |  | 郵件（支援單一 mail） |

#### 捐贈參數

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `state` | string | ✓ | 發票捐贈：`0`-無，`1`-捐贈 |
| `donationCode` | string | ✓* | 捐贈碼（當 state=1 時必填） |

#### 載具參數（擇一）

**重要**：如果**不列印感熱紙**，必須填寫 `phone` 或 `orderCode` 其中一個。

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `phone` | string | ✓* | 手機條碼載具（範例：`/1234567`） |
| `orderCode` | string | ✓* | 其他載具：會員卡號、自然人憑證、悠遊卡等 |

**手機條碼驗證規則**：
1. 第 1 碼為 `/`
2. 其餘 7 碼由數字 `0-9`、大寫英文 `A-Z`、特殊符號 `(+)(-)(.)` 組成

**orderCode 範例**：
- 會員卡號：`M123456`
- 自然人憑證：`AA12345678`
- 信用卡載具：`CC1234567890`
- icash/悠遊卡/一卡通卡號
- 電子郵件：`user@example.com`

#### 課稅參數

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `taxType` | int |  | 課稅別類型：`0`-應稅，`1`-零稅率，`2`-免稅，`3`-特種稅，`4`-混合稅<br>（預設跟隨系統設定） |

**混合稅類型額外參數**（當 taxType=4 時）：

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `companyCode` | string |  | 客戶統一編號（選填） |
| `freeAmount` | int | ✓ | 免稅銷售額合計 |
| `zeroAmount` | int | ✓ | 零稅率銷售額合計 |
| `sales` | int | ✓ | 應稅銷售額合計 |
| `amount` | int | ✓ | 稅額 |

#### 零稅率參數

當 `taxType=1` 或混合稅中包含零稅率時：

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `customsMark` | string | ✓ | 通關方式：`0`-非經海關出口，`1`-經海關出口 |
| `zeroRemark` | string | ✓ | 零稅率原因（填寫 71-79） |

**零稅率原因代碼**：
- `71`: 第一款 外銷貨物
- `72`: 第二款 與外銷有關之勞務，或在國內提供而在國外使用之勞務
- `73`: 第三款 依法設立之免稅商店銷售與過境或出境旅客之貨物
- `74`: 第四款 銷售與保稅區營業人供營運之貨物或勞務
- `75`: 第五款 國際間之運輸
- `76`: 第六款 國際運輸用之船舶、航空器及遠洋漁船
- `77`: 第七款 銷售與國際運輸用之船舶、航空器及遠洋漁船所使用之貨物或修繕勞務
- `78`: 第八款 保稅區營業人銷售與課稅區營業人未輸往課稅區而直接出口之貨物
- `79`: 第九款 保稅區營業人銷售與課稅區營業人存入自由港區事業或海關管理之保稅倉庫、物流中心以供外銷之貨物

#### 商品明細（items）

`items` 為商品集合（陣列），每個商品包含：

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `name` | string | ✓ | 商品名稱（請勿有特殊符號） |
| `money` | int | ✓ | 單價（可為 0，至少需有一筆為 1 以上） |
| `number` | int | ✓ | 數量 |
| `taxType` | int | ✓* | 商品課稅別類型：`0`-應稅，`1`-零稅率，`2`-免稅<br>（混合稅類型必填） |
| `remark` | string |  | 單一商品備註（請勿有特殊符號） |

### 請求範例（使用測試帳號）

```json
{
  "timeStamp": "1729696800000",
  "uncode": "53418005",
  "idno": "Giveme09",
  "sign": "CALCULATED_MD5_SIGN_IN_UPPERCASE",
  "customerName": "測試客戶",
  "phone": "/ABC1234",
  "datetime": "2025-10-23",
  "email": "customer@example.com",
  "state": "0",
  "taxType": 0,
  "totalFee": "100",
  "content": "感謝惠顧",
  "items": [
    {
      "name": "商品A",
      "money": 50,
      "number": 1,
      "remark": ""
    },
    {
      "name": "商品B",
      "money": 50,
      "number": 1,
      "remark": ""
    }
  ]
}
```

**注意**：`sign` 欄位需使用當前時間戳計算：
```php
$sign = strtoupper(md5($timeStamp . 'Giveme09' . '9VHGCq'));
```

### 回應參數

| 參數名稱 | 類型 | 說明 |
|---------|------|------|
| `success` | string | 成功：`true`，失敗：`false` |
| `code` | string | 發票號碼（success=true 時回傳） |
| `msg` | string | 錯誤描述 |
| `totalFee` | string | 開立發票商品總金額 |
| `orderCode` | string | 編號載具（會員載具），無資料則空值 |
| `phone` | string | 財政部手機條碼載具，無資料則空值 |

### 成功回應範例

```json
{
  "success": "true",
  "code": "AB12345678",
  "totalFee": "100",
  "orderCode": "",
  "phone": "/ABC1234"
}
```

### 失敗回應範例

```json
{
  "success": "false",
  "msg": "簽名驗證失敗"
}
```

---

## B2B 發票開立

### API 資訊
- **Action**: `addB2B`
- **Method**: `POST`
- **URL**: `https://www.giveme.com.tw/invoice.do?action=addB2B`
- **Content-Type**: `application/json`

### 請求參數

#### 基本參數（必填）

與 B2C 相同的基本參數：`timeStamp`, `uncode`, `idno`, `sign`

#### 發票資訊參數

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `phone` | string | ✓ | **買方統一編號**（B2B 必填） |
| `datetime` | string | ✓ | 發票日期 `yyyy-MM-dd` 或電腦時間毫秒數 |
| `taxState` | string | ✓ | 單價是否含稅：`0`-含稅（預設），`1`-未稅 |
| `totalFee` | string | ✓ | 總金額（amount + sales） |
| `amount` | string | ✓ | 稅額 |
| `sales` | string | ✓ | 未稅金額（淨額） |
| `content` | string | ✓ | 總備註（顯示於網頁及發票上） |
| `customerName` | string |  | 買方公司名稱（非必填） |
| `email` | string |  | 郵件（支援單一 mail） |
| `taxType` | int |  | 課稅別類型：`0`-應稅，`1`-零稅率，`2`-免稅<br>（預設跟隨系統設定） |

#### 商品明細（items）

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `name` | string | ✓ | 商品名稱（請勿有特殊符號） |
| `money` | double | ✓ | 單價（最多兩位小數） |
| `number` | int | ✓ | 數量 |
| `remark` | string |  | 單一商品備註（請勿有特殊符號） |

#### 零稅率參數（當 taxType=1 時）

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `customsMark` | string | ✓ | 通關方式：`0`-非經海關出口，`1`-經海關出口 |
| `zeroRemark` | string | ✓ | 零稅率原因（填寫 71-79） |

### 請求範例（使用測試帳號）

```json
{
  "timeStamp": "1729696800000",
  "uncode": "53418005",
  "idno": "Giveme09",
  "sign": "CALCULATED_MD5_SIGN_IN_UPPERCASE",
  "customerName": "ABC公司",
  "phone": "87654321",
  "datetime": "2025-10-23",
  "email": "company@example.com",
  "taxState": "0",
  "totalFee": "525",
  "amount": "25",
  "sales": "500",
  "taxType": 0,
  "content": "感謝惠顧",
  "items": [
    {
      "name": "商品A",
      "money": 250.00,
      "number": 2,
      "remark": ""
    }
  ]
}
```

**注意**：`sign` 欄位需使用當前時間戳計算：
```php
$sign = strtoupper(md5($timeStamp . 'Giveme09' . '9VHGCq'));
```

### 回應參數

| 參數名稱 | 類型 | 說明 |
|---------|------|------|
| `success` | string | 成功：`true`，失敗：`false` |
| `code` | string | 發票號碼（success=true 時回傳） |
| `msg` | string | 錯誤描述 |
| `phone` | string | 買方統一編號 |
| `totalFee` | string | 開立發票商品總金額 |

---

## 發票作廢

### API 資訊
- **Action**: `cancelInvoice`
- **Method**: `POST`
- **URL**: `https://www.giveme.com.tw/invoice.do?action=cancelInvoice`
- **Content-Type**: `application/json`

### 請求參數

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `timeStamp` | string | ✓ | 當前時間毫秒數（5分鐘內有效） |
| `uncode` | string | ✓ | 貴公司統一編號 |
| `idno` | string | ✓ | API 帳號 |
| `sign` | string | ✓ | 簽名（MD5 加密） |
| `code` | string | ✓ | 發票號碼 |
| `remark` | string | ✓ | 作廢原因 |

### 請求範例（使用測試帳號）

```json
{
  "timeStamp": "1729696800000",
  "uncode": "53418005",
  "idno": "Giveme09",
  "sign": "CALCULATED_MD5_SIGN_IN_UPPERCASE",
  "code": "AB12345678",
  "remark": "客戶要求作廢"
}
```

**注意**：`sign` 欄位需使用當前時間戳計算：
```php
$sign = strtoupper(md5($timeStamp . 'Giveme09' . '9VHGCq'));
```

### 回應參數

| 參數名稱 | 類型 | 說明 |
|---------|------|------|
| `success` | string | 成功：`true`，失敗：`false` |
| `code` | string | 發票號碼（success=true 時回傳） |
| `msg` | string | 錯誤描述 |

---

## 發票查詢

### API 資訊
- **Action**: `query`
- **Method**: `POST`
- **URL**: `https://www.giveme.com.tw/invoice.do?action=query`
- **Content-Type**: `application/json`

### 請求參數

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `timeStamp` | string | ✓ | 當前時間毫秒數（5分鐘內有效） |
| `uncode` | string | ✓ | 貴公司統一編號 |
| `idno` | string | ✓ | API 帳號 |
| `sign` | string | ✓ | 簽名（MD5 加密） |
| `code` | string | ✓ | 發票號碼 |

### 回應參數

| 參數名稱 | 類型 | 說明 |
|---------|------|------|
| `success` | string | 成功：`true`，失敗：`false` |
| `code` | string | 發票號碼 |
| `msg` | string | 錯誤描述 |
| `type` | string | 發票類型：`0`-B2C，`1`-B2B |
| `tranno` | string | 載具（開立時有輸入載具者）/ 買方統編 |
| `email` | string | 郵件 |
| `totalFee` | string | 總金額 |
| `randomCode` | string | 4 位隨機碼 |
| `datetime` | string | 發票日期 |
| `status` | string | 狀態：`0`-正常，`1`-作廢 |
| `delRemark` | string | 作廢說明（status=1 時回傳） |
| `delTime` | string | 作廢時間（status=1 時回傳）<br>範例：`2023-02-02 10:00:00` |
| `details` | array | 商品明細集合 |
| `details.name` | string | 商品名稱 |
| `details.number` | string | 數量 |
| `details.money` | string | 金額 |

### 回應範例

```json
{
  "success": "true",
  "code": "AB12345678",
  "type": "0",
  "tranno": "/ABC1234",
  "email": "customer@example.com",
  "totalFee": "100",
  "randomCode": "5678",
  "datetime": "2025-10-22",
  "status": "0",
  "details": [
    {
      "name": "商品A",
      "number": "1",
      "money": "50"
    },
    {
      "name": "商品B",
      "number": "1",
      "money": "50"
    }
  ]
}
```

---

## 發票列印

### 1. 網頁列印（GET）

#### API 資訊
- **Action**: `invoicePrint`
- **Method**: `GET`
- **URL**: `https://www.giveme.com.tw/invoice.do?action=invoicePrint&code={code}&uncode={uncode}`

#### 請求參數

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `code` | string | ✓ | 發票號碼 |
| `uncode` | string | ✓ | 貴公司統一編號 |

#### 範例

```
GET https://www.giveme.com.tw/invoice.do?action=invoicePrint&code=AB12345678&uncode=12345678
```

### 2. 圖片列印（POST）

#### API 資訊
- **Action**: `picture`
- **Method**: `POST`
- **URL**: `https://www.giveme.com.tw/invoice.do?action=picture`
- **Content-Type**: `application/json`

#### 請求參數

| 參數名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| `timeStamp` | string | ✓ | 當前時間毫秒數（5分鐘內有效） |
| `uncode` | string | ✓ | 貴公司統一編號 |
| `idno` | string | ✓ | API 帳號 |
| `sign` | string | ✓ | 簽名（MD5 加密） |
| `code` | string | ✓ | 發票號碼 |
| `type` | string | ✓ | 選擇需要類型，獲取圖片<br>`1`- 發票證明聯 + 交易明細<br>`2`- 發票證明聯<br>`3`- 交易明細 |

#### 回應

**成功**：返回文件流（Stream），可直接保存為圖片

**失敗**：
```json
{
  "success": "false",
  "code": "AB12345678",
  "msg": "錯誤描述"
}
```

### 3. 雲列印（選配）

**說明**：
1. 需選購雲發票機
2. 需啟用雲列印加值服務
3. 透過 WiFi 或手機分享網路，直接列印感熱紙發票
4. 支援手機 / 平板 / 電腦 / 筆電列印
5. 可多台多人員同時使用

**詳情請洽**：Line 客服 ID `@giveme`

---

## 錯誤處理

### 常見錯誤

| 錯誤訊息 | 原因 | 解決方案 |
|---------|------|---------|
| 簽名驗證失敗 | sign 計算錯誤 | 檢查 timeStamp、idno、password 組合<br>確認轉為大寫 |
| 時間戳過期 | timeStamp 超過 5 分鐘 | 使用當前時間的毫秒數 |
| IP 不在白名單 | 來源 IP 未授權 | 在後台新增伺服器 IP 到白名單 |
| 發票號碼不存在 | 查詢不存在的發票 | 確認發票號碼正確 |
| 發票已作廢 | 重複作廢 | 先查詢發票狀態 |
| 載具格式錯誤 | phone 手機條碼格式不正確 | 檢查手機條碼格式規則 |
| 總金額不符 | totalFee 與商品總額不符 | 確認計算正確 |

### 錯誤回應格式

```json
{
  "success": "false",
  "msg": "錯誤描述文字"
}
```

---

## 測試流程

### 1. 準備工作

1. **✅ 已取得測試帳號**
   - 統編: `53418005`
   - 證號: `Giveme09`
   - 密碼: `9VHGCq`

2. **設定白名單**
   - 確認測試伺服器的對外 IP
   - 聯繫 Giveme Line 客服 `@giveme` 在後台加入白名單
   - ⚠️ **重要**：未加入白名單將無法調用 API

3. **設定環境變數**
   - 在 `.env` 中設定測試環境參數：
   ```env
   GIVEME_INVOICE_API_URL=https://www.giveme.com.tw/invoice.do
   GIVEME_INVOICE_TEST_TAX_ID=53418005
   GIVEME_INVOICE_TEST_ACCOUNT=Giveme09
   GIVEME_INVOICE_TEST_PASSWORD=9VHGCq
   ```

### 2. 測試順序

建議按以下順序測試：

1. **B2C 發票開立（基本）**
   - 測試最簡單的應稅發票
   - 確認簽名機制正確
   - 確認基本參數無誤

2. **B2C 發票查詢**
   - 使用步驟 1 的發票號碼查詢
   - 確認發票資訊正確

3. **B2C 發票作廢**
   - 作廢步驟 1 的發票
   - 再次查詢確認狀態為作廢

4. **B2C 發票開立（載具）**
   - 測試手機條碼載具
   - 測試其他編號載具

5. **B2C 發票開立（捐贈）**
   - 測試發票捐贈功能

6. **B2B 發票開立**
   - 測試公司行號發票

7. **零稅率 / 免稅發票**
   - 測試不同課稅類型

8. **混合稅發票**
   - 測試混合課稅類型

### 3. Postman 測試

參考 PDF 第 1 頁的 Postman 截圖說明：

1. Method 選擇 `POST`
2. URL: `https://www.giveme.com.tw/invoice.do?action=addB2C`
3. Headers: `Content-Type: application/json`
4. Body: 選擇 `raw` → `JSON`
5. 貼上測試 JSON
6. 點擊 `Send`

### 4. Controller 測試

系統提供兩種測試 Controller：

#### GivemeDataTestController（API 直接測試）

**位置**：`app\Domains\ApiPosV2\Http\Controllers\Sale\InvoiceIssue\GivemeDataTestController.php`

**測試方法**：
- `testSignature()` - 測試簽名算法
- `testB2C()` - 測試 B2C 發票（前端傳完整資料）
- `testB2B()` - 測試 B2B 發票（前端傳完整資料）
- `testQuery()` - 測試發票查詢
- `testCancel()` - 測試發票作廢
- `showConfig()` - 查看當前環境設定

**使用時機**：開發階段測試 API 連線

#### GivemeTestController（完整流程測試）

**位置**：`app\Domains\ApiPosV2\Http\Controllers\Sale\InvoiceIssue\GivemeTestController.php`

**測試方法**：
- `issueB2C()` - 開立 B2C 發票（從資料庫讀取）
- `issueB2B()` - 開立 B2B 發票（從資料庫讀取）
- `cancel()` - 作廢發票
- `query()` - 查詢發票

**前端傳送**：`invoice_id`, `order_id`, `order_code`

**使用時機**：功能測試、UAT 測試

---

## 開發建議

### 1. Service 層架構

建議建立以下 Service：

```
app\Domains\ApiPosV2\Services\Invoice\
├── GivemeInvoiceService.php      # 主要服務類
├── InvoiceSignature.php          # 簽名產生器
├── InvoiceValidator.php          # 參數驗證器
└── InvoiceFormatter.php          # 格式轉換器
```

### 2. Model 層

發票 Model 範例：

```php
// app\Domains\ApiPosV2\Models\Invoice.php
class Invoice extends Model
{
    // 動態判斷發票類型
    public function getInvoiceTypeAttribute(): string
    {
        return !empty($this->tax_id_number) ? 'B2B' : 'B2C';
    }

    public function isB2B(): bool
    {
        return !empty($this->tax_id_number);
    }

    // 載具參數處理
    public function getCarrierParams(): array
    {
        $params = ['state' => '0'];

        switch ($this->carrier_type) {
            case 'donation':
                $params['state'] = '1';
                $params['donationCode'] = $this->donation_code;
                break;
            case 'phone_barcode':
                $params['phone'] = $this->carrier_number;
                break;
            case 'none':
                // 無載具，不傳參數
                break;
            default:
                $params['orderCode'] = $this->carrier_number;
                break;
        }

        return $params;
    }
}
```

### 3. 錯誤處理

```php
try {
    $result = $invoiceService->createB2C($invoice);
} catch (InvoiceException $e) {
    // 記錄錯誤
    Log::error('Invoice API Error: ' . $e->getMessage(), [
        'invoice_id' => $invoice->id,
        'request' => $e->getRequest(),
        'response' => $e->getResponse(),
    ]);

    // 返回錯誤訊息
    return response()->json([
        'success' => false,
        'message' => $e->getMessage(),
    ], 400);
}
```

### 4. 日誌記錄

建議記錄所有 API 請求/回應：

```php
Log::channel('invoice')->info('Giveme Invoice API Request', [
    'action' => 'addB2C',
    'invoice_no' => $response['code'] ?? null,
    'request' => $requestData,
    'response' => $response,
]);
```

---

## 參考資料

- **API 文檔**: `docs/API文檔-Giveme電子發票加值中心.pdf`
- **Line 客服**: `@giveme`
- **測試 Controller**:
  - `app\Domains\ApiPosV2\Http\Controllers\Sale\InvoiceIssue\GivemeDataTestController.php`（API 直接測試）
  - `app\Domains\ApiPosV2\Http\Controllers\Sale\InvoiceIssue\GivemeTestController.php`（完整流程測試）

---

## 版本記錄

| 版本 | 日期 | 說明 |
|------|------|------|
| 1.0 | 2025-10-22 | 初始版本，根據 Giveme API 5.0 文檔整理 |
| 2.0 | 2025-10-23 | 新增資料表結構分析、欄位對應表 |
| 3.2 | 2025-10-23 | 加入測試環境帳密資料（統編: 53418005），更新所有範例 |
| 4.0 | 2025-10-23 | 補充發票作業流程說明（兩階段設計），明確區分 Controller 類型 |

---

**整理者**: Claude Code
**最後更新**: 2025-10-23
**測試帳號**: 統編 53418005 / 帳號 Giveme09

---

## 快速參考

### Controller 使用指南

| 需求 | 使用 Controller | 前端傳送 |
|------|----------------|---------|
| 建立發票內容 | `InvoiceController` | 完整發票資料 |
| 測試 API 連線 | `GivemeDataTestController` | 完整發票資料 |
| 測試完整流程 | `GivemeTestController` | invoice_id, order_id, order_code |
| 正式開立發票 | `GivemeController` | invoice_id, order_id, order_code |
