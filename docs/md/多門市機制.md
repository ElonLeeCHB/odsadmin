# 多門市（Multi-Store）權限機制設計文件

## 概述

本文件說明如何實現多門市權限管理系統，允許一個使用者擁有多個門市的訪問權限。

### 設計原則

- **方案**：獨立的使用者-店舖關聯表（user_stores）
- **資料表命名**：`stores`（門市/店舖）
- **權限架構**：
  - **角色/權限**：由 Spatie Permission 管理（使用者可以做什麼）
  - **店舖訪問**：由 user_stores 管理（使用者可以在哪裡做）

### 架構圖

```
使用者 (users)
  ├─ 角色 (roles) - Spatie Permission 管理
  │   └─ 權限 (permissions)
  └─ 店舖 (stores) - 獨立關聯表管理
      └─ user_stores (pivot)
```

---

## 1. 資料庫設計

### 1.1 stores 資料表

```sql
CREATE TABLE stores (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    code VARCHAR(50) UNIQUE NOT NULL COMMENT '門市代碼',
    name VARCHAR(255) NOT NULL COMMENT '門市名稱',
    address TEXT COMMENT '地址',
    phone VARCHAR(50) COMMENT '電話',
    manager_id BIGINT UNSIGNED COMMENT '店長 user_id',
    is_active TINYINT(1) DEFAULT 1 COMMENT '是否啟用',
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    INDEX idx_code (code),
    INDEX idx_manager_id (manager_id),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='門市資料表';
```

### 1.2 user_stores 中間表

```sql
CREATE TABLE user_stores (
    user_id BIGINT UNSIGNED NOT NULL,
    store_id BIGINT UNSIGNED NOT NULL,
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    PRIMARY KEY (user_id, store_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (store_id) REFERENCES stores(id) ON DELETE CASCADE,
    INDEX idx_store_id (store_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='使用者-門市關聯表';
```

### 1.3 Migration 檔案

#### 建立 stores 表

```php
// database/migrations/YYYY_MM_DD_HHMMSS_create_stores_table.php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('stores', function (Blueprint $table) {
            $table->id();
            $table->string('code', 50)->unique()->comment('門市代碼');
            $table->string('name')->comment('門市名稱');
            $table->text('address')->nullable()->comment('地址');
            $table->string('phone', 50)->nullable()->comment('電話');
            $table->unsignedBigInteger('manager_id')->nullable()->comment('店長 user_id');
            $table->boolean('is_active')->default(true)->comment('是否啟用');
            $table->timestamps();

            $table->index('code');
            $table->index('manager_id');
            $table->index('is_active');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('stores');
    }
};
```

#### 建立 user_stores 中間表

```php
// database/migrations/YYYY_MM_DD_HHMMSS_create_user_stores_table.php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('user_stores', function (Blueprint $table) {
            $table->unsignedBigInteger('user_id');
            $table->unsignedBigInteger('store_id');
            $table->timestamps();

            $table->primary(['user_id', 'store_id']);

            $table->foreign('user_id')
                  ->references('id')
                  ->on('users')
                  ->onDelete('cascade');

            $table->foreign('store_id')
                  ->references('id')
                  ->on('stores')
                  ->onDelete('cascade');

            $table->index('store_id');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('user_stores');
    }
};
```

---

## 2. Model 實現

### 2.1 Store Model

```php
// app/Models/Store.php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;

class Store extends Model
{
    protected $fillable = [
        'code',
        'name',
        'address',
        'phone',
        'manager_id',
        'is_active',
    ];

    protected $casts = [
        'is_active' => 'boolean',
    ];

    /**
     * 擁有此門市訪問權限的使用者
     */
    public function users(): BelongsToMany
    {
        return $this->belongsToMany(User::class, 'user_stores')
                    ->withTimestamps();
    }

    /**
     * 門市店長
     */
    public function manager(): BelongsTo
    {
        return $this->belongsTo(User::class, 'manager_id');
    }

    /**
     * 取得啟用的門市
     */
    public function scopeActive($query)
    {
        return $query->where('is_active', true);
    }
}
```

### 2.2 User Model 擴充

```php
// app/Models/User.php
// 新增以下方法到現有的 User Model

use App\Models\Store;

/**
 * 使用者可訪問的門市
 */
public function stores(): BelongsToMany
{
    return $this->belongsToMany(Store::class, 'user_stores')
                ->withTimestamps();
}

/**
 * 使用者管理的門市（作為店長）
 */
public function managedStores(): HasMany
{
    return $this->hasMany(Store::class, 'manager_id');
}

/**
 * 檢查使用者是否有訪問指定門市的權限
 *
 * @param int $storeId
 * @return bool
 */
public function hasAccessToStore(int $storeId): bool
{
    return $this->stores()->where('stores.id', $storeId)->exists();
}

/**
 * 檢查使用者是否為指定門市的店長
 *
 * @param int $storeId
 * @return bool
 */
public function isManagerOfStore(int $storeId): bool
{
    return $this->managedStores()->where('id', $storeId)->exists();
}

/**
 * 取得使用者可訪問的門市 ID 陣列
 *
 * @return array
 */
public function getAccessibleStoreIds(): array
{
    return $this->stores()->pluck('stores.id')->toArray();
}
```

---

## 3. Service 層實現

### 3.1 StoreService

```php
// app/Domains/Admin/Services/System/StoreService.php
<?php

namespace App\Domains\Admin\Services\System;

use App\Models\Store;
use App\Services\Service;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Validator;

class StoreService extends Service
{
    protected $modelName = "App\\Models\\Store";

    public function __construct()
    {
        $this->model = new Store();
    }

    /**
     * 取得門市列表
     */
    public function getStores($data = [])
    {
        $query = Store::query();

        // 搜尋過濾
        if (!empty($data['filter_name'])) {
            $query->where('name', 'like', '%' . $data['filter_name'] . '%');
        }

        if (!empty($data['filter_code'])) {
            $query->where('code', 'like', '%' . $data['filter_code'] . '%');
        }

        if (isset($data['filter_is_active'])) {
            $query->where('is_active', $data['filter_is_active']);
        }

        // 排序
        $sort = $data['sort'] ?? 'id';
        $order = $data['order'] ?? 'ASC';
        $query->orderBy($sort, $order);

        // 分頁
        $limit = $data['limit'] ?? 20;

        return $query->paginate($limit);
    }

    /**
     * 查找或創建新記錄
     */
    public function findOrFailOrNew($id = null)
    {
        if ($id) {
            return Store::findOrFail($id);
        }

        return new Store();
    }

    /**
     * 驗證器
     */
    public function validator($data)
    {
        $rules = [
            'code' => 'required|string|max:50',
            'name' => 'required|string|max:255',
        ];

        // 如果是編輯，檢查代碼唯一性（排除自己）
        if (!empty($data['store_id'])) {
            $rules['code'] .= '|unique:stores,code,' . $data['store_id'];
        } else {
            $rules['code'] .= '|unique:stores,code';
        }

        $messages = [
            'code.required' => '門市代碼為必填',
            'code.unique' => '門市代碼已存在',
            'name.required' => '門市名稱為必填',
        ];

        return Validator::make($data, $rules, $messages);
    }

    /**
     * 建立或更新門市
     */
    public function updateOrCreate($data)
    {
        DB::beginTransaction();

        try {
            $store_id = $data['store_id'] ?? null;

            if ($store_id) {
                $store = Store::findOrFail($store_id);
            } else {
                $store = new Store();
            }

            $store->code = $data['code'];
            $store->name = $data['name'];
            $store->address = $data['address'] ?? null;
            $store->phone = $data['phone'] ?? null;
            $store->manager_id = $data['manager_id'] ?? null;
            $store->is_active = $data['is_active'] ?? true;

            $store->save();

            $result['data']['store_id'] = $store->id;

            DB::commit();

            return $result;

        } catch (\Exception $e) {
            DB::rollBack();

            $result['error'] = $e->getMessage();

            return $result;
        }
    }

    /**
     * 刪除門市
     */
    public function destroy($ids)
    {
        DB::beginTransaction();

        try {
            if (!is_array($ids)) {
                $ids = [$ids];
            }

            foreach ($ids as $id) {
                $store = Store::findOrFail($id);
                $store->delete();
            }

            DB::commit();

            return ['success' => true];

        } catch (\Exception $e) {
            DB::rollBack();

            return ['error' => $e->getMessage()];
        }
    }
}
```

### 3.2 UserService 擴充

```php
// app/Domains/Admin/Services/System/Access/UserService.php
// 在 updateOrCreate 方法中新增店舖同步邏輯

public function updateOrCreate($data)
{
    DB::beginTransaction();

    try {
        // ... 原有的使用者建立/更新邏輯 ...

        // 同步門市權限
        if (isset($data['stores'])) {
            $stores = is_array($data['stores']) ? $data['stores'] : [];
            $user->stores()->sync($stores);
        }

        // ... 其他邏輯 ...

        DB::commit();

        return $result;

    } catch (\Exception $e) {
        DB::rollBack();
        return ['error' => $e->getMessage()];
    }
}
```

---

## 4. Controller 實現

### 4.1 StoreController

```php
// app/Domains/Admin/Http/Controllers/System/StoreController.php
<?php

namespace App\Domains\Admin\Http\Controllers\System;

use App\Domains\Admin\Http\Controllers\BackendController;
use App\Domains\Admin\Services\System\StoreService;
use Illuminate\Http\Request;

class StoreController extends BackendController
{
    public function __construct(
        protected Request $request,
        protected StoreService $StoreService
    ) {
        parent::__construct();
        $this->getLang(['admin/common/common', 'admin/system/store']);
    }

    public function index()
    {
        $data['lang'] = $this->lang;
        $query_data = $this->url_data ?? [];

        // Breadcrumb
        $breadcumbs[] = (object)[
            'text' => $this->lang->text_home ?? '首頁',
            'href' => route('lang.admin.dashboard'),
        ];

        $breadcumbs[] = (object)[
            'text' => '系統管理',
            'href' => 'javascript:void(0)',
            'cursor' => 'default',
        ];

        $breadcumbs[] = (object)[
            'text' => '門市管理',
            'href' => route('lang.admin.system.stores.index'),
        ];

        $data['breadcumbs'] = (object)$breadcumbs;
        $data['list'] = $this->getList();
        $data['list_url'] = route('lang.admin.system.stores.list');
        $data['add_url'] = route('lang.admin.system.stores.form');
        $data['delete_url'] = route('lang.admin.system.stores.destroy');

        return view('admin.system.store', $data);
    }

    private function getList()
    {
        $data['lang'] = $this->lang;
        $query_data = $this->url_data ?? [];

        $stores = $this->StoreService->getStores($query_data);

        if (!empty($stores)) {
            foreach ($stores as $row) {
                $row->edit_url = route('lang.admin.system.stores.form',
                    array_merge([$row->id], $query_data));
            }
        }

        $data['stores'] = $stores->withPath(route('lang.admin.system.stores.list'))
                                  ->appends($query_data);

        // 排序連結
        $sort = $query_data['sort'] ?? 'id';
        $order = $query_data['order'] ?? 'ASC';
        $next_order = ($order == 'ASC') ? 'DESC' : 'ASC';

        $data['sort'] = $sort;
        $data['order'] = strtolower($order);

        $route = route('lang.admin.system.stores.list');
        $data['sort_id'] = $route . "?sort=id&order=$next_order";
        $data['sort_code'] = $route . "?sort=code&order=$next_order";
        $data['sort_name'] = $route . "?sort=name&order=$next_order";

        $data['list_url'] = route('lang.admin.system.stores.list');

        return view('admin.system.store_list', $data);
    }

    public function form($store_id = null)
    {
        $data['lang'] = $this->lang;
        $this->lang->text_form = empty($store_id) ? '新增' : '編輯';

        // Breadcrumb
        $breadcumbs[] = (object)[
            'text' => $this->lang->text_home ?? '首頁',
            'href' => route('lang.admin.dashboard'),
        ];

        $breadcumbs[] = (object)[
            'text' => '系統管理',
            'href' => 'javascript:void(0)',
            'cursor' => 'default',
        ];

        $breadcumbs[] = (object)[
            'text' => '門市管理',
            'href' => route('lang.admin.system.stores.index'),
        ];

        $data['breadcumbs'] = (object)$breadcumbs;

        $data['save'] = route('lang.admin.system.stores.save',
            $store_id ? [$store_id] : []);
        $data['back'] = route('lang.admin.system.stores.index');

        $store = $this->StoreService->findOrFailOrNew($store_id);

        $data['store'] = $store;
        $data['store_id'] = $store_id;

        return view('admin.system.store_form', $data);
    }

    public function save($store_id = null)
    {
        $data = $this->request->all();
        $data['store_id'] = $store_id;

        $json = [];

        // Validation
        $validator = $this->StoreService->validator($this->request->post());

        if ($validator->fails()) {
            $messages = $validator->errors()->toArray();
            foreach ($messages as $key => $rows) {
                $json['error'][$key] = $rows[0];
            }
        }

        if (isset($json['error']) && !isset($json['error']['warning'])) {
            $json['error']['warning'] = '請檢查輸入的內容';
        }

        if (!$json) {
            $result = $this->StoreService->updateOrCreate($data);

            if (empty($result['error'])) {
                $json['store_id'] = $result['data']['store_id'];
                $json['success'] = '儲存成功';
                $json['redirectUrl'] = route('lang.admin.system.stores.form',
                    $result['data']['store_id']);
            } else {
                $json['error'] = $result['error'];
            }
        }

        return response(json_encode($json))->header('Content-Type', 'application/json');
    }

    public function destroy()
    {
        $ids = $this->request->input('selected', []);
        $json = [];

        if (empty($ids)) {
            $json['error'] = '請選擇要刪除的項目';
            return response(json_encode($json))->header('Content-Type', 'application/json');
        }

        $result = $this->StoreService->destroy($ids);

        if (empty($result['error'])) {
            $json['success'] = '刪除成功';
        } else {
            $json['error'] = $result['error'];
        }

        return response(json_encode($json))->header('Content-Type', 'application/json');
    }
}
```

### 4.2 UserController 擴充

在 `form()` 方法中新增門市列表：

```php
public function form($user_id = null)
{
    // ... 原有程式碼 ...

    // 取得所有門市
    $data['stores'] = \App\Models\Store::active()->orderBy('name')->get();

    // 取得使用者已分配的門市
    if ($user_id) {
        $data['user_stores'] = $user->stores->pluck('id')->toArray();
    } else {
        $data['user_stores'] = [];
    }

    return view('admin.system.access.user_form', $data);
}
```

---

## 5. Middleware 實現

### 5.1 CheckStoreAccess Middleware

```php
// app/Http/Middleware/CheckStoreAccess.php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;

class CheckStoreAccess
{
    /**
     * 檢查使用者是否有訪問當前門市的權限
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \Closure  $next
     * @return mixed
     */
    public function handle(Request $request, Closure $next)
    {
        $user = auth()->user();

        // 管理員跳過檢查
        if ($user && $user->hasRole('admin')) {
            return $next($request);
        }

        // 從路由參數或 session 取得 store_id
        $storeId = $request->route('store_id')
                   ?? $request->input('store_id')
                   ?? session('current_store_id');

        // 如果沒有指定門市，使用使用者的第一個門市
        if (!$storeId && $user) {
            $firstStore = $user->stores()->first();
            if ($firstStore) {
                $storeId = $firstStore->id;
                session(['current_store_id' => $storeId]);
            }
        }

        // 檢查權限
        if ($storeId && $user && !$user->hasAccessToStore($storeId)) {
            abort(403, '您沒有訪問此門市的權限');
        }

        // 設定當前門市到 session
        if ($storeId) {
            session(['current_store_id' => $storeId]);
        }

        return $next($request);
    }
}
```

### 5.2 註冊 Middleware

```php
// app/Http/Kernel.php

protected $middlewareAliases = [
    // ... 其他 middleware ...
    'store.access' => \App\Http\Middleware\CheckStoreAccess::class,
];
```

### 5.3 使用 Middleware

```php
// routes/admin.php

Route::middleware(['auth:admin', 'store.access'])->group(function () {
    // 需要門市權限的路由
    Route::prefix('orders')->group(function () {
        Route::get('/', [OrderController::class, 'index']);
        // ...
    });
});
```

---

## 6. View 整合

### 6.1 user_form.blade.php 新增門市選擇

```blade
{{-- 在適當位置新增以下程式碼 --}}

<legend>門市權限</legend>
<div class="row mb-3">
    <label class="col-sm-2 col-form-label">可訪問門市</label>
    <div class="col-sm-10">
        @if(count($stores) > 0)
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
                @foreach($stores as $store)
                <div class="form-check">
                    <input type="checkbox"
                           name="stores[]"
                           value="{{ $store->id }}"
                           class="form-check-input"
                           id="store-{{ $store->id }}"
                           @if(in_array($store->id, $user_stores)) checked @endif>
                    <label class="form-check-label" for="store-{{ $store->id }}">
                        <strong>{{ $store->name }}</strong> ({{ $store->code }})
                        @if($store->address)
                            <br><small class="text-muted">{{ $store->address }}</small>
                        @endif
                    </label>
                </div>
                @endforeach
            </div>
            <div class="form-text">
                選擇此使用者可以訪問的門市。如未選擇任何門市，使用者將無法訪問門市相關功能。
            </div>
        @else
            <div class="alert alert-warning">目前沒有任何門市，請先建立門市。</div>
        @endif
        <div id="error-stores" class="invalid-feedback"></div>
    </div>
</div>
```

### 6.2 門市切換選單（Layout）

```blade
{{-- 在後台 header 新增門市切換下拉選單 --}}

@if(auth()->check() && auth()->user()->stores->count() > 0)
<div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="storeDropdown" data-bs-toggle="dropdown">
        <i class="fas fa-store"></i>
        {{ session('current_store_name', '選擇門市') }}
    </button>
    <ul class="dropdown-menu" aria-labelledby="storeDropdown">
        @foreach(auth()->user()->stores as $store)
        <li>
            <a class="dropdown-item @if(session('current_store_id') == $store->id) active @endif"
               href="{{ route('lang.admin.store.switch', $store->id) }}">
                {{ $store->name }} ({{ $store->code }})
            </a>
        </li>
        @endforeach
    </ul>
</div>
@endif
```

### 6.3 門市切換路由

```php
// app/Domains/Admin/Routes/admin.php

Route::get('store/switch/{store_id}', function($store_id) {
    $store = \App\Models\Store::findOrFail($store_id);

    if (!auth()->user()->hasAccessToStore($store_id)) {
        abort(403, '您沒有訪問此門市的權限');
    }

    session([
        'current_store_id' => $store->id,
        'current_store_name' => $store->name,
    ]);

    return redirect()->back()->with('success', '已切換到：' . $store->name);
})->name('store.switch');
```

---

## 7. 使用範例

### 7.1 在 Controller 中取得當前門市

```php
// 在任何 Controller 中
$currentStoreId = session('current_store_id');

// 或使用 helper
$currentStore = \App\Models\Store::find(session('current_store_id'));

// 只查詢當前門市的訂單
$orders = Order::where('store_id', $currentStoreId)->get();
```

### 7.2 在 Model 中自動過濾門市

```php
// app/Models/Order.php

protected static function booted()
{
    static::addGlobalScope('store', function ($query) {
        if (session('current_store_id') && !auth()->user()->hasRole('admin')) {
            $query->where('store_id', session('current_store_id'));
        }
    });
}
```

### 7.3 檢查權限

```php
// 檢查使用者是否有訪問門市的權限
if ($user->hasAccessToStore($storeId)) {
    // 允許訪問
}

// 檢查使用者是否為店長
if ($user->isManagerOfStore($storeId)) {
    // 店長特殊權限
}

// 取得使用者可訪問的所有門市 ID
$storeIds = $user->getAccessibleStoreIds();
```

### 7.4 分配門市權限

```php
// 為使用者分配門市權限
$user->stores()->attach([1, 2, 3]); // 新增
$user->stores()->sync([1, 2, 3]);   // 同步（會移除其他）
$user->stores()->detach([1, 2]);    // 移除
```

---

## 8. 路由設計

### 8.1 門市管理路由

```php
// app/Domains/Admin/Routes/admin.php

Route::group([
    'prefix' => 'system',
    'as' => 'system.',
], function () {
    // 門市管理
    Route::get('stores', 'System\StoreController@index')->name('stores.index');
    Route::get('stores/list', 'System\StoreController@list')->name('stores.list');
    Route::get('stores/form/{store_id?}', 'System\StoreController@form')->name('stores.form');
    Route::post('stores/save/{store_id?}', 'System\StoreController@save')->name('stores.save');
    Route::post('stores/destroy', 'System\StoreController@destroy')->name('stores.destroy');
});
```

---

## 9. 測試場景

### 9.1 單元測試範例

```php
// tests/Unit/StoreAccessTest.php

public function test_user_can_access_assigned_store()
{
    $user = User::factory()->create();
    $store = Store::factory()->create();

    $user->stores()->attach($store->id);

    $this->assertTrue($user->hasAccessToStore($store->id));
}

public function test_user_cannot_access_unassigned_store()
{
    $user = User::factory()->create();
    $store = Store::factory()->create();

    $this->assertFalse($user->hasAccessToStore($store->id));
}
```

---

## 10. 注意事項

### 10.1 效能考量

- 使用 eager loading 避免 N+1 問題：
  ```php
  $users = User::with('stores')->get();
  ```

- 快取使用者的門市列表：
  ```php
  $stores = Cache::remember("user.{$userId}.stores", 3600, function() use ($user) {
      return $user->stores;
  });
  ```

### 10.2 安全性考量

- 所有涉及門市資料的操作都要檢查權限
- 使用 Middleware 統一管理門市訪問控制
- 管理員（admin）可以訪問所有門市
- 避免在前端暴露所有門市資料

### 10.3 資料完整性

- 刪除門市前檢查是否有關聯資料（訂單、庫存等）
- 使用軟刪除（Soft Delete）保留歷史記錄
- 定期清理無效的 user_stores 關聯

---

## 11. 未來擴充方向

### 11.1 門市群組

如果需要管理多個門市群組（如區域、品牌）：

```sql
CREATE TABLE store_groups (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255),
    parent_id BIGINT UNSIGNED NULL
);

ALTER TABLE stores ADD COLUMN group_id BIGINT UNSIGNED;
```

### 11.2 門市特定角色

如果需要不同門市有不同角色：

```sql
-- 在 user_stores 加入 role_id
ALTER TABLE user_stores ADD COLUMN role_id BIGINT UNSIGNED;

-- 使用範例
$user->stores()->attach($storeId, ['role_id' => $roleId]);
```

### 11.3 門市間資料共享

設定某些資料（如商品、客戶）是否跨門市共享。

---

## 12. 實施步驟

1. ✅ 執行 Migration 建立 `stores` 和 `user_stores` 表
2. ✅ 建立 Store Model
3. ✅ 更新 User Model 新增關聯方法
4. ✅ 建立 StoreService
5. ✅ 建立 StoreController
6. ✅ 建立門市管理的 View
7. ✅ 更新 UserService 支援門市同步
8. ✅ 更新 user_form.blade.php 新增門市選擇
9. ✅ 建立 CheckStoreAccess Middleware
10. ✅ 在需要的路由註冊 Middleware
11. ✅ 建立門市切換功能
12. ✅ 測試多門市權限功能

---

## 13. 相關文件

- [Spatie Laravel Permission 文件](https://spatie.be/docs/laravel-permission)
- Laravel Eloquent Relationships
- Laravel Middleware

---

**文件版本**: 1.0
**最後更新**: 2025-11-19
**維護團隊**: Development Team
