# 發票開立流程草案

## 目錄

1. [需求背景](#需求背景)
2. [核心原則](#核心原則)
3. [統一入口設計：Resolve 端點](#統一入口設計resolve-端點)
4. [API 端點規劃](#api-端點規劃)
5. [前端流程設計](#前端流程設計)
6. [散客快速開票流程](#散客快速開票流程)
7. [RESTful 設計考量](#restful-設計考量)
8. [實作狀態](#實作狀態)

---

## 需求背景

### 現有問題

1. **發票和訂單都有相似的邏輯**：
   - 提供一個訂單編號或發票號碼
   - 尋找所屬群組
   - 找出該群組所有訂單、所有發票

2. **散客快速開票需求**：
   - 標準一張訂單，要開一張發票
   - 如何快速方便的完成？

3. **URL 設計困境**：
   - 現行：`/invoices/groups/edit?order_id=123`
   - 問題：如果訂單尚未加入群組，頁面視為「新增」，但 `edit` 語意是「編輯」
   - 這不符合 RESTful 規範

### 設計目標

- 統一所有開票方式的入口
- 保持 RESTful 語意清晰
- 提供直覺的前端使用體驗
- 支援散客快速開票

---

## 核心原則

> **重要：所有開票方式都必須建立群組，包括標準一對一。**

### 群組架構回顧

```
1群組, 1訂單, 1發票  → 標準（一對一）
1群組, 1訂單, N發票  → 拆單
1群組, N訂單, 1發票  → 合併
1群組, N訂單, N發票  → 混合
```

### 判斷邏輯

| 查詢參數 | 找到群組 | 模式 |
|----------|----------|------|
| `order_id` / `order_code` | 是 | 編輯模式（查看/修改現有群組） |
| `order_id` / `order_code` | 否 | 新增模式（為訂單建立群組） |
| `invoice_id` / `invoice_number` | 是 | 編輯模式（查看/修改現有群組） |
| `invoice_id` / `invoice_number` | 否 | 錯誤（孤立發票，不應發生） |
| `group_id` / `group_no` | 是 | 編輯模式 |
| `group_id` / `group_no` | 否 | 錯誤（群組不存在） |
| 無參數 | - | 新增模式（空白頁面） |

---

## 統一入口設計：Resolve 端點

### 設計理念

將現有的 `edit` 端點重新定義為 **「解析開票上下文」** 的功能，而非單純的「編輯頁資料」。

### 新端點命名

```
GET /api/posv2/sales/invoices/groups/resolve
```

### 參數說明

| 參數 | 優先順序 | 說明 |
|------|----------|------|
| `group_id` | 1 | 群組 ID |
| `group_no` | 2 | 群組編號 |
| `order_id` | 3 | 訂單 ID |
| `order_code` | 4 | 訂單編號 |
| `invoice_id` | 5 | 發票 ID |
| `invoice_number` | 6 | 發票號碼 |

### 回應結構

```json
{
  "success": true,
  "data": {
    "mode": "create" | "edit",          // 操作模式
    "used_param": "order_id",           // 實際使用的查詢參數
    "group": { ... } | null,            // 群組資料（edit 模式）
    "orders": [ ... ],                  // 相關訂單
    "invoices": [ ... ],                // 相關發票
    "invoice_defaults": { ... }         // 發票預設值（create 模式）
  }
}
```

### 回應範例

#### 情境 1：訂單尚未開票（新增模式）

```http
GET /api/posv2/sales/invoices/groups/resolve?order_id=123
```

```json
{
  "success": true,
  "data": {
    "mode": "create",
    "used_param": "order_id",
    "group": null,
    "orders": [
      {
        "id": 123,
        "code": "ORD20251209001",
        "payment_total": 1000,
        "payment_tin": null,
        "order_products": [ ... ],
        "order_totals": [ ... ]
      }
    ],
    "invoices": [],
    "invoice_defaults": {
      "invoice_type": "single",
      "invoice_date": "2025-12-09",
      "carrier_type": "none",
      "invoice_items": [ ... ]
    }
  }
}
```

#### 情境 2：訂單已在群組中（編輯模式）

```http
GET /api/posv2/sales/invoices/groups/resolve?order_id=123
```

```json
{
  "success": true,
  "data": {
    "mode": "edit",
    "used_param": "order_id",
    "group": {
      "id": 456,
      "group_no": "20250001",
      "invoice_issue_mode": "standard",
      "status": "active",
      "order_count": 1,
      "invoice_count": 1,
      "total_amount": 1000
    },
    "orders": [ ... ],
    "invoices": [ ... ],
    "invoice_defaults": null
  }
}
```

---

## API 端點規劃

### 完整端點列表

| 方法 | 端點 | 說明 |
|------|------|------|
| `GET` | `/invoices/groups/resolve` | 解析開票上下文（統一入口） |
| `GET` | `/invoices/groups/check-order` | 檢查訂單是否可加入群組 |
| `POST` | `/invoices/groups` | 建立發票群組 |
| `GET` | `/invoices/groups/{id}` | 取得群組詳情（含 orders, invoices） |
| `PUT` | `/invoices/groups/{id}` | 更新發票群組 |

### 路由定義

```php
// app/Domains/ApiPosV2/Routes/apipos.php

// 發票群組（開票作業）
Route::prefix('groups')->name('groups.')->group(function () {
    // 統一入口：解析開票上下文
    Route::get('/resolve', [InvoiceGroupController::class, 'resolve'])->name('resolve');
    // 訂單檢查
    Route::get('/check-order', [InvoiceGroupController::class, 'checkOrder'])->name('check-order');

    // RESTful CRUD
    Route::post('/', [InvoiceGroupController::class, 'store'])->name('store');
    Route::get('/{id}', [InvoiceGroupController::class, 'show'])->name('show');
    Route::put('/{id}', [InvoiceGroupController::class, 'update'])->name('update');
});
```

---

## 前端流程設計

### 流程圖

```
┌─────────────────────────────────────────────────────────────┐
│                      前端入口                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  來源 A：訂單列表            來源 B：發票列表                  │
│  「開發票」按鈕               「編輯」按鈕                     │
│       │                          │                          │
│       ▼                          ▼                          │
│  order_id=123              invoice_id=456                   │
│       │                          │                          │
│       └──────────┬───────────────┘                          │
│                  │                                          │
│                  ▼                                          │
│     GET /invoices/groups/resolve?{param}                    │
│                  │                                          │
│                  ▼                                          │
│         ┌───────────────┐                                   │
│         │   mode: ?     │                                   │
│         └───────┬───────┘                                   │
│                 │                                           │
│     ┌───────────┴───────────┐                               │
│     │                       │                               │
│     ▼                       ▼                               │
│  mode: create          mode: edit                           │
│     │                       │                               │
│     ▼                       ▼                               │
│  顯示空白表單            顯示現有資料                         │
│  預填訂單商品            載入群組訂單、發票                    │
│     │                       │                               │
│     ▼                       ▼                               │
│  POST /groups           PUT /groups/{id}                    │
│     │                       │                               │
│     └───────────┬───────────┘                               │
│                 │                                           │
│                 ▼                                           │
│            儲存完成                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 前端路由設計

```javascript
// 前端路由（Vue Router / React Router）

// 方案 A：使用 query 參數（推薦）
/invoices/groups/form?order_id=123      // 從訂單進入
/invoices/groups/form?invoice_id=456    // 從發票進入
/invoices/groups/form?group_id=789      // 直接指定群組
/invoices/groups/form                   // 空白新增

// 方案 B：使用 path 參數
/invoices/groups/new?order_id=123       // 新增模式
/invoices/groups/edit/789               // 編輯模式（group_id）
```

### 前端元件狀態管理

```javascript
// InvoiceGroupForm.vue / InvoiceGroupForm.tsx

const state = {
  mode: null,           // 'create' | 'edit'
  loading: true,
  group: null,
  orders: [],
  invoices: [],
  invoiceDefaults: null,
};

async function loadContext() {
  const params = route.query; // { order_id, invoice_id, group_id, ... }

  const response = await api.get('/invoices/groups/resolve', { params });

  state.mode = response.data.mode;
  state.group = response.data.group;
  state.orders = response.data.orders;
  state.invoices = response.data.invoices;
  state.invoiceDefaults = response.data.invoice_defaults;
  state.loading = false;
}

async function save() {
  if (state.mode === 'create') {
    await api.post('/invoices/groups', formData);
  } else {
    await api.put(`/invoices/groups/${state.group.id}`, formData);
  }
}
```

---

## 散客快速開票流程

### 情境描述

> 散客結帳，一張訂單開一張發票，需要最快速的方式完成。

### 操作步驟

```
1. 訂單列表點擊「開發票」
      │
      ▼
2. 前端導向 /invoices/groups/form?order_id=123
      │
      ▼
3. 呼叫 GET /invoices/groups/resolve?order_id=123
      │
      ▼
4. 後端判斷：訂單尚未開票 → mode: create
      │
      ▼
5. 前端載入：
   - 訂單資料（商品、金額）
   - 發票預設值（日期=今天、類型=單聯式）
   - 自動帶入商品明細
      │
      ▼
6. 使用者確認/調整（載具、買受人等）
      │
      ▼
7. 點擊「儲存」→ POST /invoices/groups
      │
      ▼
8. 完成，跳轉回訂單列表或發票列表
```

### 快速開票的 UX 優化

1. **自動帶入商品明細**
   - 從 `order_products` 自動轉換為 `invoice_items`
   - 加價購選項自動拆分為獨立項目

2. **預設值最佳化**
   - 發票日期：今天
   - 發票類型：單聯式（散客常用）
   - 載具：無（紙本）
   - 開票模式：標準（一對一）

3. **一鍵開票按鈕**（進階功能）
   - 訂單列表直接提供「快速開票」按鈕
   - 使用預設值直接建立群組，不進入表單頁

---

## RESTful 設計考量

### 為什麼不用 `edit`？

| 端點名稱 | 問題 |
|----------|------|
| `GET /groups/edit?order_id=123` | `edit` 暗示資源已存在，但訂單可能還沒有群組 |

### 為什麼用 `resolve`？

| 端點名稱 | 語意 |
|----------|------|
| `GET /groups/resolve?order_id=123` | 「解析這筆訂單的開票上下文」|

### Resolve 的語意

- **動作**：解析並決定該做什麼
- **回傳**：mode（create/edit）+ 相關資料
- 明確表達「解析並給我答案」的意圖

### 替代方案比較

| 方案 | URL | 優點 | 缺點 |
|------|-----|------|------|
| A. `context` | `GET /groups/context?order_id=123` | 語意清楚，單一入口 | 非標準 RESTful |
| B. `resolve` | `GET /groups/resolve?order_id=123` | 明確表達「解析」動作 | 同上 |
| C. 分開端點 | `GET /groups/check` + `GET /groups/{id}` | 純 RESTful | 前端需多次請求 |
| D. RPC 風格 | `POST /groups/resolve-context` | 明確是動作而非資源 | 破壞 GET 冪等性 |

### 採用方案 B（resolve）

理由：
1. **務實考量**：單一入口減少前端複雜度
2. **語意清楚**：`resolve` 明確表示「解析並給出結論」
3. **GET 適用**：純查詢，無副作用，符合 GET 語意
4. **業界慣例**：許多 SaaS 系統使用類似設計

---

## 實作狀態

### 已完成 ✅

#### 1. Controller 修改

`InvoiceGroupController.php` 已新增 `resolve()` 方法：
- 新增 `mode` 回傳欄位（`create` / `edit`）
- 新增 `invoice_defaults` 回傳欄位（create 模式時提供預設值）
- 保留 `edit()` 作為 `resolve()` 的別名（向後相容）

#### 2. 新增 getInvoiceDefaults() 方法

提供發票預設值：
- `invoice_type`: 單聯式（有統編時自動改為三聯式）
- `invoice_format`: 小張熱感紙
- `invoice_date`: 今天日期
- `carrier_type`: 無載具（紙本）
- `tax_type`: 應稅
- `tax_included`: 含稅
- `invoice_items`: 預設發票項目
- `suggested_invoice_items`: 訂單商品建議明細（如有訂單）
- `buyer_name`: 買受人（如訂單有）
- `tax_id_number`: 統編（如訂單有）

#### 3. 新增 show() 方法

標準 RESTful `GET /groups/{id}` 端點，查詢群組詳情：
```php
public function show(int $id): JsonResponse
{
    // 載入群組及其 orders, invoices
    // 返回完整的群組資料
}
```

#### 4. 路由更新

```php
// app/Domains/ApiPosV2/Routes/apipos.php

Route::prefix('groups')->name('groups.')->group(function () {
    Route::get('/resolve', ...)->name('resolve');   // 解析開票上下文
    Route::get('/check-order', ...)->name('check-order');
    Route::post('/', ...)->name('store');
    Route::get('/{id}', ...)->name('show');         // 群組詳情
    Route::put('/{id}', ...)->name('update');
});
```

#### 5. InvoiceController 更新

`edit_url` 已改為使用 `resolve` 端點：
```php
$invoice->edit_url = route('api.posv2.sales.invoices.groups.resolve', ['invoice_id' => $invoice->id]);
```

---

## 總結

### 關鍵決策

1. **端點命名**：使用 `resolve` 取代 `edit`，更準確表達「解析開票上下文」的語意
2. **統一入口**：所有開票操作都從 `resolve` 端點開始，由後端判斷模式
3. **群組強制**：即使一對一開票，也必須建立群組
4. **向後相容**：保留 `edit` 路由作為別名

### 前端體驗

- 單一入口，自動判斷新增/編輯
- 散客快速開票：從訂單一鍵進入，預填資料
- 減少前端條件判斷的複雜度

### 相關檔案

- Controller: `app/Domains/ApiPosV2/Http/Controllers/Sale/InvoiceGroupController.php`
- Controller: `app/Domains/ApiPosV2/Http/Controllers/Sale/InvoiceController.php`
- Routes: `app/Domains/ApiPosV2/Routes/apipos.php`

---

**文件版本**: 1.1
**建立日期**: 2025-12-09
**更新日期**: 2025-12-09（實作完成）
**相關文件**: `[FN]統一發票1概述.md`, `[FN]統一發票2串接.md`
