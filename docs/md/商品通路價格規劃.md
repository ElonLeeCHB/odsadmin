# 商品通路價格規劃

## 需求說明

後台 `/backend/catalog/products/form/{id}` 需新增**通路售價**功能。

由於外送平台（如 UberEats、Foodpanda）會抽成，門市需針對不同通路設定不同售價，與門市自己接單的價格區隔。

---

## 現有架構分析

### 相關資料表

| 資料表 | 用途 |
|--------|------|
| `products` | 商品主表，含 `price` 欄位（門市原價） |
| `product_metas` | EAV 結構的商品擴展資料 |
| `taxonomies` + `terms` | 系統分類管理 |

### 現況問題

- 目前 `products.price` 僅儲存單一售價
- 無法針對不同銷售通路設定不同價格
- 無銷售通路的 taxonomy 定義

---

## 解決方案

### 方案架構

```
┌─────────────┐      ┌──────────────────────┐      ┌─────────────┐
│  products   │──1:N─│ product_channel_prices│──N:1─│    terms    │
│  (商品主表) │      │    (通路價格表)       │      │ (通路選項)  │
└─────────────┘      └──────────────────────┘      └─────────────┘
                              │                           │
                              │ channel_code              │ code
                              └───────────────────────────┘
                                (WHERE taxonomy_code='sales_channel')
```

### 1. 新增 Taxonomy - 銷售通路

```sql
-- 新增 taxonomy
INSERT INTO taxonomies (code, is_active, comment, created_at, updated_at)
VALUES ('sales_channel', 1, '銷售通路', NOW(), NOW());

-- 新增 terms (通路選項)
INSERT INTO terms (taxonomy_code, code, name, sort_order, is_active, created_at, updated_at) VALUES
('sales_channel', '1', 'UberEats', 1, 1, NOW(), NOW()),
('sales_channel', '2', 'Foodpanda', 2, 1, NOW(), NOW()),
('sales_channel', '3', 'inline 訂位', 3, 1, NOW(), NOW());
-- 可依需求擴充更多通路...
```

### 2. 新增資料表 `product_channel_prices`

#### 資料表結構

| 欄位 | 類型 | 說明 |
|------|------|------|
| `id` | BIGINT UNSIGNED | 主鍵 |
| `product_id` | BIGINT UNSIGNED | 商品 ID (FK → products.id) |
| `channel_code` | TINYINT UNSIGNED | 通路代碼 (→ terms.code WHERE taxonomy_code='sales_channel') |
| `price` | DECIMAL(13,4) | 通路售價 |
| `start_date` | DATE | 生效日期，NULL = 立即生效 |
| `end_date` | DATE | 結束日期，NULL = 永久有效 |
| `is_active` | TINYINT(1) | 啟用狀態，預設 1 |
| `created_at` | TIMESTAMP | 建立時間 |
| `updated_at` | TIMESTAMP | 更新時間 |

#### DDL

```sql
CREATE TABLE product_channel_prices (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    product_id BIGINT UNSIGNED NOT NULL,
    channel_code TINYINT UNSIGNED NOT NULL COMMENT '通路代碼，關聯 terms.code (WHERE taxonomy_code=sales_channel)',
    price DECIMAL(13,4) NOT NULL COMMENT '通路售價',
    start_date DATE NULL COMMENT '生效日期，NULL=立即生效',
    end_date DATE NULL COMMENT '結束日期，NULL=永久有效',
    is_active TINYINT(1) DEFAULT 1 COMMENT '啟用狀態',
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,

    INDEX idx_product_channel (product_id, channel_code),
    INDEX idx_channel_active (channel_code, is_active),
    INDEX idx_date_range (start_date, end_date),

    CONSTRAINT fk_pcp_product
        FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='商品通路價格表。channel_code 關聯 terms.code (條件: taxonomy_code=sales_channel)';
```

#### 範例資料

```sql
-- product_id=101 的商品，在各通路的售價
INSERT INTO product_channel_prices (product_id, channel_code, price, is_active) VALUES
(101, '1', 105.0000, 1),  -- UberEats 售價 105
(101, '2', 108.0000, 1);  -- Foodpanda 售價 108
```

---

## 設計考量

### code 關聯設計說明

本系統 `terms.code` 不是全域唯一，而是在 **taxonomy 範圍內唯一**。

關聯查詢時需搭配 `taxonomy_code` 條件：

```php
// Model 關聯定義
public function channel()
{
    return $this->belongsTo(Term::class, 'channel_code', 'code')
        ->where('taxonomy_code', 'sales_channel');
}

// channel_code 為 TINYINT，關聯時會自動轉型比對 terms.code (INT)
```

此設計優點：
- `code` 可使用簡短編碼（1, 2, 3...），方便外部系統對接
- 與現有系統慣例一致（如 `products.source_type_code`）
- 透過資料表 COMMENT 說明關聯邏輯，便於維護

### 為何不用 `product_metas`？

| 考量 | EAV (product_metas) | 獨立資料表 |
|------|---------------------|------------|
| 查詢效能 | 較差，需多次 JOIN | 較佳，單表查詢 |
| 時間區間 | 難以處理 | 原生支援 |
| 資料完整性 | 弱 | 可設 FK 約束 |
| 擴展性 | 高但複雜 | 結構清晰 |

### 時間區間設計

| start_date | end_date | 意義 |
|------------|----------|------|
| NULL | NULL | 永久有效（常態價格） |
| 2024-01-01 | NULL | 從指定日期起永久有效 |
| 2024-01-01 | 2024-01-31 | 限定期間（促銷價） |
| NULL | 2024-12-31 | 即刻生效至指定日期 |

---

## 實作規劃

### 檔案清單

```
app/
├── Models/Catalog/
│   └── ProductChannelPrice.php          # Model
├── Domains/Admin/
│   ├── Http/Controllers/Catalog/
│   │   └── ProductChannelPriceController.php  # Controller (如需獨立 API)
│   └── Views/admin/catalog/products/
│       └── _channel_prices.blade.php    # 表單區塊
database/
└── migrations/
    └── 2024_xx_xx_create_product_channel_prices_table.php
```

### Model 範例

```php
<?php

namespace App\Models\Catalog;

use Illuminate\Database\Eloquent\Model;
use App\Models\Common\Term;

class ProductChannelPrice extends Model
{
    protected $fillable = [
        'product_id',
        'channel_code',
        'price',
        'start_date',
        'end_date',
        'is_active',
    ];

    protected $casts = [
        'channel_code' => 'integer',
        'price' => 'decimal:4',
        'start_date' => 'date',
        'end_date' => 'date',
        'is_active' => 'boolean',
    ];

    public function product()
    {
        return $this->belongsTo(Product::class);
    }

    /**
     * 關聯通路 Term
     * channel_code → terms.code (WHERE taxonomy_code='sales_channel')
     */
    public function channel()
    {
        return $this->belongsTo(Term::class, 'channel_code', 'code')
            ->where('taxonomy_code', 'sales_channel');
    }

    /**
     * 取得目前有效的價格
     */
    public function scopeActive($query)
    {
        return $query->where('is_active', 1)
            ->where(function ($q) {
                $q->whereNull('start_date')
                  ->orWhere('start_date', '<=', now());
            })
            ->where(function ($q) {
                $q->whereNull('end_date')
                  ->orWhere('end_date', '>=', now());
            });
    }

    /**
     * 依通路篩選
     */
    public function scopeForChannel($query, int $channelCode)
    {
        return $query->where('channel_code', $channelCode);
    }
}
```

### Product Model 新增關聯

```php
// app/Models/Catalog/Product.php

use App\Models\Catalog\ProductChannelPrice;

public function channelPrices()
{
    return $this->hasMany(ProductChannelPrice::class);
}

/**
 * 取得特定通路的有效售價
 * @param int $channelCode 通路代碼 (1=UberEats, 2=Foodpanda, ...)
 */
public function getChannelPrice(int $channelCode): ?float
{
    $channelPrice = $this->channelPrices()
        ->forChannel($channelCode)
        ->active()
        ->orderBy('start_date', 'desc') // 優先取最新設定
        ->first();

    return $channelPrice?->price;
}

/**
 * 取得售價（支援通路）
 * @param int|null $channelCode 通路代碼，NULL 則回傳門市原價
 */
public function getPriceForChannel(?int $channelCode = null): float
{
    if ($channelCode) {
        $channelPrice = $this->getChannelPrice($channelCode);
        if ($channelPrice !== null) {
            return $channelPrice;
        }
    }

    return $this->price; // 回傳門市原價
}
```

---

## 使用情境

### 情境 1：POS API 查詢商品價格

```php
// app/Domains/ApiPosV2/Http/Controllers/...

public function getProduct(Request $request, $id)
{
    $product = Product::find($id);
    $channelCode = (int) $request->header('X-Channel-Code'); // 1=UberEats, 2=Foodpanda

    return response()->json([
        'id' => $product->id,
        'name' => $product->name,
        'price' => $product->getPriceForChannel($channelCode),
        'original_price' => $product->price,
    ]);
}
```

### 情境 2：後台管理通路價格

```php
// 取得商品所有通路價格（含通路名稱）
$product = Product::with(['channelPrices.channel'])->find($id);

foreach ($product->channelPrices as $cp) {
    echo $cp->channel->name . ': ' . $cp->price;
    // UberEats: 105
    // Foodpanda: 108
}

// 新增/更新通路價格
$product->channelPrices()->updateOrCreate(
    ['channel_code' => 1], // UberEats
    [
        'price' => 110,
        'start_date' => null,
        'end_date' => null,
        'is_active' => true,
    ]
);
```

### 情境 3：批次查詢多商品通路價格

```php
$products = Product::with(['channelPrices' => function ($query) {
    $query->active()->forChannel(2); // Foodpanda
}])->whereIn('id', $productIds)->get();
```

---

## 後台 UI 規劃

### 商品編輯頁面新增區塊

在 `/backend/catalog/products/form/{id}` 頁面新增「通路價格」Tab 或區塊：

```
┌─────────────────────────────────────────────────────┐
│ 通路價格設定                                         │
├─────────────────────────────────────────────────────┤
│ ┌─────────┬──────────┬────────────┬────────────┬───┐│
│ │ 通路     │ 售價     │ 生效日期   │ 結束日期   │啟用││
│ ├─────────┼──────────┼────────────┼────────────┼───┤│
│ │ UberEats │ 105      │ -          │ -          │ ✓ ││
│ │ Foodpanda│ 108      │ 2024-01-01 │ 2024-12-31 │ ✓ ││
│ │ inline   │ 100      │ -          │ -          │ ✓ ││
│ └─────────┴──────────┴────────────┴────────────┴───┘│
│                                        [+ 新增通路]  │
└─────────────────────────────────────────────────────┘
```

---

## 注意事項

1. **價格優先順序**：通路價格 > 門市原價
2. **時間重疊處理**：同通路若有多筆有效價格，取 `start_date` 最新者
3. **快取策略**：商品通路價格變更時，需清除相關快取
4. **權限控管**：通路價格編輯需有對應後台權限

---

## 版本紀錄

| 版本 | 日期 | 說明 |
|------|------|------|
| 1.0 | 2025-12-11 | 初版規劃 |
| 1.1 | 2025-12-11 | 調整 channel_code 為 TINYINT 類型（1, 2, 3...），更新相關程式碼範例 |

---

**文件維護**：Development Team
