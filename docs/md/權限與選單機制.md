# æ¬Šé™æ©Ÿåˆ¶è¨­è¨ˆæ–‡ä»¶

## ç›®éŒ„

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ ¸å¿ƒè¨­è¨ˆåŸå‰‡](#æ ¸å¿ƒè¨­è¨ˆåŸå‰‡)
  - [name å’Œ parent_id çš„è·è²¬åˆ†å·¥](#name-å’Œ-parent_id-çš„è·è²¬åˆ†å·¥)
  - [ç‚ºä»€éº¼ä¿ç•™ parent_id](#ç‚ºä»€éº¼ä¿ç•™-parent_id)
- [è³‡æ–™è¡¨çµæ§‹](#è³‡æ–™è¡¨çµæ§‹)
  - [permissionsï¼ˆæ¬Šé™/é¸å–®ï¼‰](#permissionsæ¬Šé™é¸å–®)
  - [rolesï¼ˆè§’è‰²ï¼‰](#rolesè§’è‰²)
  - [role_has_permissionsï¼ˆè§’è‰²-æ¬Šé™é—œè¯ï¼‰](#role_has_permissionsè§’è‰²-æ¬Šé™é—œè¯)
  - [model_has_rolesï¼ˆä½¿ç”¨è€…-è§’è‰²é—œè¯ï¼‰](#model_has_rolesä½¿ç”¨è€…-è§’è‰²é—œè¯)
- [å¤šç³»çµ±é¸å–®æ©Ÿåˆ¶](#å¤šç³»çµ±é¸å–®æ©Ÿåˆ¶)
  - [ç³»çµ±å€åˆ†æ–¹å¼](#ç³»çµ±å€åˆ†æ–¹å¼)
  - [é¸å–®æ¸²æŸ“é‚è¼¯](#é¸å–®æ¸²æŸ“é‚è¼¯)
- [é¸å–®å¿«å–ç­–ç•¥](#é¸å–®å¿«å–ç­–ç•¥)
  - [å…©å±¤å¿«å–è¨­è¨ˆ](#å…©å±¤å¿«å–è¨­è¨ˆ)
  - [è§’è‰²çµ„åˆå¿«å–éµç”Ÿæˆ](#è§’è‰²çµ„åˆå¿«å–éµç”Ÿæˆ)
  - [æ•ˆèƒ½å„ªå‹¢](#æ•ˆèƒ½å„ªå‹¢)
  - [å¿«å–æ¸…é™¤ç­–ç•¥](#å¿«å–æ¸…é™¤ç­–ç•¥)
- [Type é¡å‹èªªæ˜](#type-é¡å‹èªªæ˜)
- [æ¬Šé™å‘½åè¦å‰‡](#æ¬Šé™å‘½åè¦å‰‡)
- [é¸å–®é¡¯ç¤ºæ©Ÿåˆ¶](#é¸å–®é¡¯ç¤ºæ©Ÿåˆ¶)
- [å¯¦éš›è³‡æ–™ç¯„ä¾‹](#å¯¦éš›è³‡æ–™ç¯„ä¾‹)
- [æ¬Šé™åˆ¤æ–·æµç¨‹](#æ¬Šé™åˆ¤æ–·æµç¨‹)
- [è§’è‰²æ¬Šé™åˆ†é…å»ºè­°](#è§’è‰²æ¬Šé™åˆ†é…å»ºè­°)
- [æ¬Šé™æª¢æŸ¥æ–¹å¼](#æ¬Šé™æª¢æŸ¥æ–¹å¼)
- [MenuService ä½¿ç”¨æŒ‡å—](#menuservice-ä½¿ç”¨æŒ‡å—)
  - [åŸºæœ¬ä½¿ç”¨](#åŸºæœ¬ä½¿ç”¨)
  - [Admin å¾Œå°ç¯„ä¾‹](#admin-å¾Œå°ç¯„ä¾‹)
  - [POS API ç¯„ä¾‹](#pos-api-ç¯„ä¾‹)
  - [æ‰‹å‹•æ¸…é™¤å¿«å–](#æ‰‹å‹•æ¸…é™¤å¿«å–)
- [æœªä¾†æ“´å……](#æœªä¾†æ“´å……)

---

## æ¦‚è¿°

æœ¬ç³»çµ±æ¡ç”¨ **RBACï¼ˆRole-Based Access Controlï¼‰æ¬Šé™æ¨¡å‹**ï¼Œå°‡é¸å–®èˆ‡æ¬Šé™åˆä¸€ï¼Œé€éæ¨¹ç‹€çµæ§‹ç®¡ç†ã€‚

**æ ¸å¿ƒç‰¹è‰²ï¼š**
- âœ… é¸å–®å’Œæ¬Šé™éƒ½å­˜åœ¨åŒä¸€å¼µè¡¨ï¼ˆ`permissions`ï¼‰
- âœ… é€é `type` å€åˆ†é¸å–®é …ç›®ï¼ˆmenuï¼‰å’ŒåŠŸèƒ½æ¬Šé™ï¼ˆactionï¼‰
- âœ… ä½¿ç”¨ `parent_id` å»ºç«‹æ¨¹ç‹€çµæ§‹
- âœ… ä½¿ç”¨ `name` å‰ç¶´å€åˆ†ä¸åŒç³»çµ±ï¼ˆposã€adminã€wwwï¼‰
- âœ… æ”¯æ´å¤šè§’è‰²ï¼Œæ¬Šé™è‡ªå‹•åˆä½µï¼ˆè¯é›†ï¼‰

---

## æ ¸å¿ƒè¨­è¨ˆåŸå‰‡

### name å’Œ parent_id çš„è·è²¬åˆ†å·¥

é›–ç„¶ `name` ä½¿ç”¨å°æ•¸é»åˆ†éš”å±¤ç´šï¼ˆå¦‚ `admin.sales.order`ï¼‰ï¼Œçœ‹ä¼¼èˆ‡ `parent_id` é‡è¤‡ï¼Œä½†å…©è€…**è·è²¬ä¸åŒï¼Œäº’è£œè€Œéé‡è¤‡**ã€‚

| æ¬„ä½ | ç”¨é€” | ç¯„ä¾‹ | çµ¦èª°ç”¨ |
|------|------|------|--------|
| **name** | æ¬Šé™ä»£ç¢¼ï¼Œèªæ„åŒ–å‘½åï¼Œç”¨æ–¼ç¨‹å¼åˆ¤æ–· | `admin.sales.order.list` | ç¨‹å¼ã€é–‹ç™¼è€… |
| **parent_id** | è³‡æ–™åº«é—œè¯ï¼Œç”¨æ–¼æŸ¥è©¢å’Œç¶­è­·æ¨¹ç‹€çµæ§‹ | `4` (æŒ‡å‘çˆ¶å±¤) | è³‡æ–™åº«ã€ORM |

**å¯¦ä¾‹èªªæ˜ï¼š**

```php
// âœ… name ç”¨æ–¼æ¬Šé™åˆ¤æ–·ï¼ˆèªæ„åŒ–ï¼‰
@can('admin.sales.order.list')
    <a href="/admin/orders">è¨‚å–®åˆ—è¡¨</a>
@endcan

// âœ… parent_id ç”¨æ–¼æŸ¥è©¢é—œè¯ï¼ˆæ•ˆèƒ½å„ªåŒ–ï¼‰
$children = $permission->children;  // é€é parent_id ç›´æ¥æŸ¥è©¢
$parent = $permission->parent;      // é€é parent_id ç›´æ¥é—œè¯
```

---

### ç‚ºä»€éº¼ä¿ç•™ parent_id

#### 1. æŸ¥è©¢æ•ˆç‡

```php
// âœ… æœ‰ parent_idï¼šä¸€æ¬¡æŸ¥è©¢
$children = $permission->children;  // SELECT * FROM permissions WHERE parent_id = ?

// âŒ æ²’æœ‰ parent_idï¼šéœ€è¦å­—ä¸²è™•ç†
$childrenNames = Permission::where('name', 'like', $this->name . '.%')->get();
// é‚„è¦éæ¿¾å‡ºç›´æ¥å­å±¤ï¼ˆä¸å«å­«å±¤ï¼‰ï¼Œéœ€è¦é¡å¤–é‚è¼¯
```

#### 2. è³‡æ–™å®Œæ•´æ€§

```sql
-- âœ… æœ‰ parent_idï¼šå¤–éµç´„æŸ
FOREIGN KEY (parent_id) REFERENCES permissions(id) ON DELETE CASCADE

-- âŒ æ²’æœ‰ parent_idï¼šç„¡æ³•ç´„æŸ
-- å¯èƒ½å‡ºç¾ name='admin.sales.order' ä½† 'admin.sales' ä¸å­˜åœ¨çš„æƒ…æ³
```

#### 3. ç§»å‹•é¸å–®é …ç›®

```sql
-- âœ… æœ‰ parent_idï¼šåªéœ€æ›´æ–°ä¸€å€‹æ¬„ä½
UPDATE permissions SET parent_id = 10 WHERE id = 4;

-- âŒ æ²’æœ‰ parent_idï¼šè¦æ”¹ name å’Œæ‰€æœ‰å­å­«çš„ name
UPDATE permissions SET name = 'admin.report.order' WHERE name = 'admin.sales.order';
UPDATE permissions SET name = REPLACE(name, 'admin.sales.order', 'admin.report.order')
WHERE name LIKE 'admin.sales.order.%';
```

#### 4. Laravel Eloquent åŸç”Ÿæ”¯æ´

```php
// âœ… æœ‰ parent_idï¼šä½¿ç”¨ Eloquent é—œè¯
public function parent() {
    return $this->belongsTo(Permission::class, 'parent_id');
}

public function children() {
    return $this->hasMany(Permission::class, 'parent_id')->orderBy('sort_order');
}

// å¯ä»¥ä½¿ç”¨é è¼‰å…¥å„ªåŒ–æŸ¥è©¢
$menus = Permission::with('parent', 'children')->get();
```

#### 5. è·è²¬åˆ†é›¢

- **name**ï¼šæä¾›èªæ„åŒ–ï¼ˆäººé¡å¯è®€ï¼‰
- **parent_id**ï¼šæä¾›æ•ˆèƒ½ï¼ˆæ©Ÿå™¨å¯è®€ï¼‰
- **å…©è€…ç›¸è¼”ç›¸æˆ**ï¼Œå°‘é‡å†—é¤˜æ›å–å¤§é‡ä¾¿åˆ©

---

## è³‡æ–™è¡¨çµæ§‹

### permissionsï¼ˆæ¬Šé™/é¸å–®ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | bigint | ä¸»éµ |
| parent_id | bigint | çˆ¶å±¤ IDï¼ŒNULL ç‚ºé ‚å±¤ |
| name | varchar(100) | æ¬Šé™ä»£ç¢¼ï¼Œä½¿ç”¨ `.` åˆ†æ®µ |
| guard_name | varchar(10) | å®ˆè¡›åç¨±ï¼ˆweb/apiï¼‰ |
| title | varchar(50) | é¡¯ç¤ºåç¨±ï¼ˆé¸å–®æ–‡å­—ï¼‰ |
| description | text | æ¬Šé™èªªæ˜ï¼ˆé¸å¡«ï¼‰ |
| icon | varchar(50) | åœ–ç¤º classï¼ˆFontAwesomeï¼‰ |
| sort_order | int | æ’åºï¼ˆæ•¸å­—è¶Šå°è¶Šå‰é¢ï¼‰ |
| type | enum | **menu** / **action** |
| created_at | timestamp | å»ºç«‹æ™‚é–“ |
| updated_at | timestamp | æ›´æ–°æ™‚é–“ |

**å¤–éµç´„æŸï¼š**
```sql
FOREIGN KEY (parent_id) REFERENCES permissions(id) ON DELETE CASCADE
```

---

### rolesï¼ˆè§’è‰²ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | bigint | ä¸»éµ |
| name | varchar(50) | è§’è‰²ä»£ç¢¼ |
| title | varchar(50) | é¡¯ç¤ºåç¨± |
| description | varchar(255) | èªªæ˜ |
| created_at | timestamp | |
| updated_at | timestamp | |

---

### role_has_permissionsï¼ˆè§’è‰²-æ¬Šé™é—œè¯ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| role_id | bigint | è§’è‰² ID |
| permission_id | bigint | æ¬Šé™ ID |

**èªªæ˜ï¼š**
- åŒæ™‚å„²å­˜ `type=menu` å’Œ `type=action` çš„æ¬Šé™
- ä¸€å€‹è§’è‰²å¯ä»¥æœ‰å¤šå€‹æ¬Šé™
- ä¸€å€‹æ¬Šé™å¯ä»¥åˆ†é…çµ¦å¤šå€‹è§’è‰²

---

### model_has_rolesï¼ˆä½¿ç”¨è€…-è§’è‰²é—œè¯ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| role_id | bigint | è§’è‰² ID |
| model_type | varchar | æ¨¡å‹é¡åˆ¥ï¼ˆå¦‚ App\Models\SystemUserï¼‰ |
| model_id | bigint | ä½¿ç”¨è€… ID |

**èªªæ˜ï¼š**
- ä¸€å€‹ä½¿ç”¨è€…å¯ä»¥æœ‰**å¤šå€‹è§’è‰²**
- æœ€çµ‚æ¬Šé™ç‚ºæ‰€æœ‰è§’è‰²æ¬Šé™çš„**è¯é›†**

---

## å¤šç³»çµ±é¸å–®æ©Ÿåˆ¶

æœ¬ç³»çµ±åŒ…å«å¤šå€‹å­ç³»çµ±ï¼š**å®˜ç¶²ï¼ˆwwwï¼‰**ã€**POS é»é¤ç³»çµ±ï¼ˆposï¼‰**ã€**å¾Œå°ç®¡ç†ï¼ˆadminï¼‰**ã€‚

### ç³»çµ±å€åˆ†æ–¹å¼

**é€é `name` å‰ç¶´è‡ªå‹•å€åˆ†ï¼Œä¸éœ€è¦é¡å¤–æ¬„ä½**

| ç³»çµ± | å‰ç¶´ | èªªæ˜ | ä½¿ç”¨å°è±¡ |
|------|------|------|---------|
| å®˜ç¶² | `www.*` | å®˜ç¶²å‰ç«¯åŠŸèƒ½ | ä¸€èˆ¬ä½¿ç”¨è€… |
| POS | `pos.*` | é»é¤ç³»çµ±åŠŸèƒ½ | é–€å¸‚äººå“¡ |
| Admin | `admin.*` | å¾Œå°ç®¡ç†åŠŸèƒ½ | ç³»çµ±ç®¡ç†å“¡ã€ä¸»ç®¡ |

**ç¯„ä¾‹ï¼š**
```
pos.dashboard          â†’ POS ç³»çµ±
pos.order.create       â†’ POS ç³»çµ±
admin.sales.order.list â†’ Admin ç³»çµ±
admin.system.user.edit â†’ Admin ç³»çµ±
www.product.view       â†’ å®˜ç¶²ç³»çµ±
```

---

### é¸å–®æ¸²æŸ“é‚è¼¯

**ä¸åŒç³»çµ±çš„å‰ç«¯/å¾Œå°åˆ†åˆ¥æ¸²æŸ“å°æ‡‰çš„é¸å–®**

```php
// MenuService.php

/**
 * å–å¾—ä½¿ç”¨è€…åœ¨ç‰¹å®šç³»çµ±çš„é¸å–®
 */
public function getUserMenus($user, string $system): Collection
{
    // 1. å–å¾—ä½¿ç”¨è€…æ‰€æœ‰æ¬Šé™ï¼ˆæ‰€æœ‰è§’è‰²åˆä½µï¼‰
    $userPermissions = $user->roles->flatMap->permissions->pluck('name');

    // 2. å–å¾—è©²ç³»çµ±æ‰€æœ‰ menu é¡å‹çš„æ¬Šé™
    $allMenus = Permission::where('type', 'menu')
        ->where('name', 'like', $system . '.%')  // é€éå‰ç¶´éæ¿¾ç³»çµ±
        ->orderBy('sort_order')
        ->with('parent')
        ->get();

    // 3. éæ¿¾ï¼šåªé¡¯ç¤ºæœ‰æ¬Šé™çš„é¸å–®ï¼ˆå«çˆ¶å±¤æª¢æŸ¥ï¼‰
    $visibleMenus = $allMenus->filter(function($menu) use ($userPermissions) {
        if (!$userPermissions->contains($menu->name)) {
            return false;
        }

        // æª¢æŸ¥æ‰€æœ‰ç¥–å…ˆä¹Ÿå¿…é ˆæœ‰æ¬Šé™
        foreach ($menu->ancestors() as $ancestor) {
            if (!$userPermissions->contains($ancestor->name)) {
                return false;
            }
        }

        return true;
    });

    // 4. å»ºç«‹æ¨¹ç‹€çµæ§‹
    return $this->buildMenuTree($visibleMenus);
}
```

**ä½¿ç”¨ç¯„ä¾‹ï¼š**

```php
// Admin å¾Œå° Controller
public function index(MenuService $menuService)
{
    $adminMenus = $menuService->getUserMenus(auth()->user(), 'admin');
    return view('admin.layout', compact('adminMenus'));
}

// POS API Controller
public function permissions(MenuService $menuService)
{
    $posMenus = $menuService->getUserMenus(auth()->user(), 'pos');
    return response()->json(['menus' => $posMenus]);
}
```

---

## é¸å–®å¿«å–ç­–ç•¥

ç‚ºæå‡æ•ˆèƒ½ï¼Œæœ¬ç³»çµ±æ¡ç”¨**å…©å±¤å¿«å–æ©Ÿåˆ¶**ï¼Œå¤§å¹…æ¸›å°‘è³‡æ–™åº«æŸ¥è©¢æ¬¡æ•¸èˆ‡å¿«å–æ•¸é‡ã€‚

### å…©å±¤å¿«å–è¨­è¨ˆ

#### ç¬¬ä¸€å±¤ï¼šå…¨åŸŸé¸å–®æ¨¹ï¼ˆ24å°æ™‚ï¼‰

**å¿«å–å…§å®¹**ï¼šæ‰€æœ‰ `type=menu` çš„æ¬Šé™é …ç›®ï¼ˆæ¨¹ç‹€çµæ§‹ï¼‰
**å¿«å–æ™‚é–“**ï¼š86400 ç§’ï¼ˆ24 å°æ™‚ï¼‰
**å¿«å–éµæ ¼å¼**ï¼š`menu.tree.{system}`

```php
// ç¯„ä¾‹å¿«å–éµ
menu.tree.admin  // Admin ç³»çµ±çš„å®Œæ•´é¸å–®æ¨¹
menu.tree.pos    // POS ç³»çµ±çš„å®Œæ•´é¸å–®æ¨¹
menu.tree.www    // å®˜ç¶²ç³»çµ±çš„å®Œæ•´é¸å–®æ¨¹
```

**ç‰¹é»**ï¼š
- âœ… æ‰€æœ‰ç”¨æˆ¶å…±ç”¨ï¼ˆä¸åˆ†è§’è‰²ï¼‰
- âœ… æ¸›å°‘è³‡æ–™åº«æŸ¥è©¢
- âœ… åªåœ¨æ¬Šé™è¡¨è®Šæ›´æ™‚æ¸…é™¤

**å¯¦ä½œ**ï¼š
```php
protected function getGlobalMenuTree(string $system): Collection
{
    $cacheKey = "menu.tree.{$system}";

    return Cache::remember($cacheKey, 86400, function() use ($system) {
        return Permission::where('type', 'menu')
            ->where('name', 'like', "{$system}.%")
            ->orderBy('sort_order')
            ->with(['children' => function($query) {
                $query->where('type', 'menu')->orderBy('sort_order');
            }])
            ->whereNull('parent_id')
            ->get();
    });
}
```

---

#### ç¬¬äºŒå±¤ï¼šè§’è‰²çµ„åˆé¸å–®ï¼ˆ1å°æ™‚ï¼‰

**å¿«å–å…§å®¹**ï¼šéæ¿¾å¾Œçš„ä½¿ç”¨è€…é¸å–®ï¼ˆå…¨åŸŸé¸å–® âˆ© ç”¨æˆ¶æ¬Šé™ï¼‰
**å¿«å–æ™‚é–“**ï¼š3600 ç§’ï¼ˆ1 å°æ™‚ï¼‰
**å¿«å–éµæ ¼å¼**ï¼š`menu.{system}.roles.{hash}`

```php
// ç¯„ä¾‹å¿«å–éµ
menu.admin.roles.a3f5c8d2e4b7f9a1  // è§’è‰²çµ„åˆ [2,5,7] åœ¨ Admin ç³»çµ±çš„é¸å–®
menu.pos.roles.b7e9f1a4c3d6a2b8    // è§’è‰²çµ„åˆ [1,3] åœ¨ POS ç³»çµ±çš„é¸å–®
```

**ç‰¹é»**ï¼š
- âœ… ç›¸åŒè§’è‰²çµ„åˆçš„ç”¨æˆ¶å…±ç”¨å¿«å–
- âœ… å¿«å–æ•¸é‡é å°‘æ–¼ã€Œæ¯ç”¨æˆ¶ä¸€ä»½ã€çš„æ–¹æ¡ˆ
- âœ… é«˜å¿«å–å‘½ä¸­ç‡

---

### è§’è‰²çµ„åˆå¿«å–éµç”Ÿæˆ

ä½¿ç”¨ **MD5(sorted role_ids)** ä½œç‚ºå¿«å–éµçš„ hash éƒ¨åˆ†ï¼Œç¢ºä¿ç›¸åŒè§’è‰²çµ„åˆç”¢ç”Ÿç›¸åŒçš„å¿«å–éµã€‚

#### ç”Ÿæˆé‚è¼¯

```php
protected function generateRolesCacheKey(Authenticatable $user, string $system): string
{
    // 1. å–å¾—ç”¨æˆ¶æ‰€æœ‰è§’è‰² ID
    $roleIds = $user->roles->pluck('id')->toArray();
    // çµæœï¼š[2, 5, 7]

    // 2. æ’åºï¼ˆç¢ºä¿ç›¸åŒè§’è‰²çµ„åˆç”¢ç”Ÿç›¸åŒ hashï¼‰
    sort($roleIds);
    // çµæœï¼š[2, 5, 7]

    // 3. ç”¢ç”Ÿ MD5 hash
    $rolesHash = md5(implode(',', $roleIds));
    // çµæœï¼ša3f5c8d2e4b7f9a1c6d4e8f3a2b5c7d9

    // 4. çµ„åˆå¿«å–éµ
    return "menu.{$system}.roles.{$rolesHash}";
    // çµæœï¼šmenu.admin.roles.a3f5c8d2e4b7f9a1
}
```

#### å…±ç”¨å¿«å–ç¯„ä¾‹

```
ç”¨æˆ¶ Aï¼šè§’è‰² [2, 5, 7] â†’ æ’åºå¾Œ [2, 5, 7] â†’ hash: a3f5c8d2...
ç”¨æˆ¶ Bï¼šè§’è‰² [5, 7, 2] â†’ æ’åºå¾Œ [2, 5, 7] â†’ hash: a3f5c8d2... âœ… å…±ç”¨
ç”¨æˆ¶ Cï¼šè§’è‰² [2, 5, 7] â†’ æ’åºå¾Œ [2, 5, 7] â†’ hash: a3f5c8d2... âœ… å…±ç”¨
ç”¨æˆ¶ Dï¼šè§’è‰² [1, 3]    â†’ æ’åºå¾Œ [1, 3]    â†’ hash: b7e9f1a4... âŒ ä¸åŒ
```

---

### æ•ˆèƒ½å„ªå‹¢

#### å¿«å–æ•¸é‡å°æ¯”

**å‚³çµ±æ–¹æ¡ˆï¼ˆæŒ‰ç”¨æˆ¶ï¼‰**ï¼š
```
å‡è¨­ï¼š
- 100 å€‹ç”¨æˆ¶
- 3 å€‹ç³»çµ±ï¼ˆadmin, pos, wwwï¼‰

å¿«å–æ•¸é‡ï¼š100 Ã— 3 = 300 ä»½
```

**æœ¬æ–¹æ¡ˆï¼ˆæŒ‰è§’è‰²çµ„åˆï¼‰**ï¼š
```
å‡è¨­ï¼š
- 100 å€‹ç”¨æˆ¶
- 10 ç¨®è§’è‰²çµ„åˆ
- 3 å€‹ç³»çµ±

å¿«å–æ•¸é‡ï¼š10 Ã— 3 = 30 ä»½
æ¸›å°‘ï¼š90%
```

---

#### å¿«å–å‘½ä¸­ç‡

```
æƒ…å¢ƒï¼š100 å€‹ç”¨æˆ¶ï¼Œ10 ç¨®ä¸åŒçš„è§’è‰²çµ„åˆ

é¦–æ¬¡è¨ªå•ï¼ˆå†·å•Ÿå‹•ï¼‰ï¼š
- 10 æ¬¡ MISSï¼ˆå»ºç«‹ 10 ç¨®è§’è‰²çµ„åˆçš„å¿«å–ï¼‰
- 90 æ¬¡ HITï¼ˆä½¿ç”¨å·²å»ºç«‹çš„å¿«å–ï¼‰

å‘½ä¸­ç‡ï¼š90%
```

---

#### å¯¦éš›æ¡ˆä¾‹

```
è§’è‰²çµ„åˆåˆ†å¸ƒï¼š
- çµ„åˆ 1 [2,5,7]ï¼š30 å€‹ç”¨æˆ¶ â†’ 1 ä»½å¿«å–
- çµ„åˆ 2 [1,3]ï¼š  25 å€‹ç”¨æˆ¶ â†’ 1 ä»½å¿«å–
- çµ„åˆ 3 [4]ï¼š    20 å€‹ç”¨æˆ¶ â†’ 1 ä»½å¿«å–
- çµ„åˆ 4 [2,3,5]ï¼š15 å€‹ç”¨æˆ¶ â†’ 1 ä»½å¿«å–
- çµ„åˆ 5 [1]ï¼š    10 å€‹ç”¨æˆ¶ â†’ 1 ä»½å¿«å–

ç¸½å…±ï¼š100 å€‹ç”¨æˆ¶ï¼Œåªéœ€ 5 ä»½å¿«å–
```

---

### å¿«å–æ¸…é™¤ç­–ç•¥

#### è‡ªå‹•æ¸…é™¤ï¼ˆEvent Listenerï¼‰

ä½¿ç”¨ `ClearMenuCacheListener` ç›£è½è³‡æ–™è®Šæ›´äº‹ä»¶ï¼š

```php
// app/Listeners/ClearMenuCacheListener.php

class ClearMenuCacheListener
{
    /**
     * æ¬Šé™è¡¨è®Šæ›´æ™‚ï¼šæ¸…é™¤å…¨åŸŸé¸å–®å¿«å–
     */
    public function handlePermissionChanged($event): void
    {
        $this->menuService->clearAllGlobalMenuCache();

        Log::info('å…¨åŸŸé¸å–®å¿«å–å·²æ¸…é™¤ï¼ˆæ¬Šé™è¡¨è®Šæ›´ï¼‰');
    }

    /**
     * è§’è‰²æ¬Šé™è®Šæ›´æ™‚ï¼šæ¸…é™¤æ‰€æœ‰è§’è‰²é¸å–®å¿«å–
     */
    public function handleRolePermissionsChanged($event): void
    {
        $this->menuService->clearAllGlobalMenuCache();

        $systems = ['admin', 'pos', 'www'];
        foreach ($systems as $system) {
            $this->menuService->clearAllRoleMenuCache($system);
        }

        Log::info('é¸å–®å¿«å–å·²æ¸…é™¤ï¼ˆè§’è‰²æ¬Šé™è®Šæ›´ï¼‰');
    }

    /**
     * ç”¨æˆ¶è§’è‰²è®Šæ›´æ™‚ï¼šæ¸…é™¤è©²ç”¨æˆ¶çš„é¸å–®å¿«å–
     */
    public function handleUserRolesChanged($event): void
    {
        $user = $event->user;
        $systems = ['admin', 'pos', 'www'];

        foreach ($systems as $system) {
            $this->menuService->clearUserMenuCache($user, $system);
        }

        Log::info('ç”¨æˆ¶é¸å–®å¿«å–å·²æ¸…é™¤ï¼ˆè§’è‰²è®Šæ›´ï¼‰', ['user_id' => $user->id]);
    }
}
```

---

#### äº‹ä»¶è¨»å†Š

åœ¨ `EventServiceProvider` ä¸­è¨»å†Šï¼š

```php
protected $listen = [
    // æ¬Šé™è¡¨è®Šæ›´
    'permission.created' => [ClearMenuCacheListener::class . '@handlePermissionChanged'],
    'permission.updated' => [ClearMenuCacheListener::class . '@handlePermissionChanged'],
    'permission.deleted' => [ClearMenuCacheListener::class . '@handlePermissionChanged'],

    // è§’è‰²æ¬Šé™è®Šæ›´
    'role.permissions.synced' => [ClearMenuCacheListener::class . '@handleRolePermissionsChanged'],

    // ç”¨æˆ¶è§’è‰²è®Šæ›´
    'user.roles.synced' => [ClearMenuCacheListener::class . '@handleUserRolesChanged'],
];
```

---

#### è§¸ç™¼æ™‚æ©Ÿ

| æ“ä½œ | æ¸…é™¤å¿«å– | è§¸ç™¼äº‹ä»¶ |
|------|---------|---------|
| æ–°å¢/ä¿®æ”¹/åˆªé™¤æ¬Šé™é …ç›® | å…¨åŸŸé¸å–®å¿«å–ï¼ˆæ‰€æœ‰ç³»çµ±ï¼‰ | `permission.created/updated/deleted` |
| èª¿æ•´è§’è‰²æ¬Šé™ï¼ˆrole_has_permissionsï¼‰ | å…¨åŸŸé¸å–® + æ‰€æœ‰è§’è‰²é¸å–® | `role.permissions.synced` |
| èª¿æ•´ç”¨æˆ¶è§’è‰²ï¼ˆmodel_has_rolesï¼‰ | è©²ç”¨æˆ¶çš„é¸å–®å¿«å–ï¼ˆæ‰€æœ‰ç³»çµ±ï¼‰ | `user.roles.synced` |

---

#### å¿«å–å¤±æ•ˆç¤ºæ„åœ–

```
æƒ…æ³ 1ï¼šæ–°å¢é¸å–®é …ç›®
æ“ä½œï¼šINSERT INTO permissions ...
äº‹ä»¶ï¼špermission.created
æ¸…é™¤ï¼š
  â”œâ”€ menu.tree.admin
  â”œâ”€ menu.tree.pos
  â””â”€ menu.tree.www

æƒ…æ³ 2ï¼šèª¿æ•´è§’è‰²æ¬Šé™
æ“ä½œï¼šUPDATE role_has_permissions ...
äº‹ä»¶ï¼šrole.permissions.synced
æ¸…é™¤ï¼š
  â”œâ”€ menu.tree.* ï¼ˆå…¨åŸŸï¼‰
  â”œâ”€ menu.admin.roles.* ï¼ˆæ‰€æœ‰è§’è‰²çµ„åˆï¼‰
  â”œâ”€ menu.pos.roles.*
  â””â”€ menu.www.roles.*

æƒ…æ³ 3ï¼šèª¿æ•´ç”¨æˆ¶è§’è‰²
æ“ä½œï¼šUPDATE model_has_roles WHERE user_id = 5
äº‹ä»¶ï¼šuser.roles.synced
æ¸…é™¤ï¼š
  â”œâ”€ menu.admin.roles.{èˆŠhash}
  â”œâ”€ menu.admin.roles.{æ–°hash}
  â”œâ”€ menu.pos.roles.{èˆŠhash}
  â”œâ”€ menu.pos.roles.{æ–°hash}
  â”œâ”€ menu.www.roles.{èˆŠhash}
  â””â”€ menu.www.roles.{æ–°hash}
```

---

## Type é¡å‹èªªæ˜

| Type | èªªæ˜ | é¡¯ç¤ºæ–¼é¸å–® | ç”¨é€” |
|------|------|-----------|------|
| **menu** | é¸å–®é …ç›® | âœ… æ˜¯ | é¡¯ç¤ºæ–¼å°è¦½åˆ—çš„é¸å–®é …ç›®æˆ–é é¢ |
| **action** | åŠŸèƒ½æ¬Šé™ | âŒ å¦ | åŠŸèƒ½æŒ‰éˆ•ã€æ“ä½œæ¬Šé™ï¼ˆä¸é¡¯ç¤ºåœ¨é¸å–®ï¼‰ |

### è¨­è¨ˆåŸå‰‡

- **æ‰€æœ‰ `type=menu` çš„é …ç›®éƒ½æœƒé¡¯ç¤ºåœ¨é¸å–®ä¸­**ï¼ˆå‰ææ˜¯ä½¿ç”¨è€…æœ‰è©²æ¬Šé™åŠæ‰€æœ‰çˆ¶å±¤æ¬Šé™ï¼‰
- **ä¸éœ€è¦ `is_menu` æ¬„ä½**ï¼Œå› ç‚º `type` å·²ç¶“æ±ºå®šæ˜¯å¦é¡¯ç¤º
- **`action` é¡å‹ä¸éœ€è¦å¡«å¯«**ï¼š`parent_id`ã€`title`ã€`icon`ã€`sort_order` ç­‰é¸å–®ç›¸é—œæ¬„ä½

### ç¯„ä¾‹

```
admin.sales              type=menu     (é¸å–®åˆ†é¡ - éŠ·å”®æ¨¡çµ„)
â”œâ”€â”€ admin.sales.order    type=menu     (é¸å–®é …ç›® - è¨‚å–®ä½œæ¥­)
    â”œâ”€â”€ admin.sales.order.list    type=menu     (é¸å–®é é¢ - åˆ—è¡¨)
    â”œâ”€â”€ admin.sales.order.create  type=action   (åŠŸèƒ½æŒ‰éˆ• - æ–°å¢)
    â”œâ”€â”€ admin.sales.order.edit    type=action   (åŠŸèƒ½æŒ‰éˆ• - ç·¨è¼¯)
    â”œâ”€â”€ admin.sales.order.delete  type=action   (åŠŸèƒ½æŒ‰éˆ• - åˆªé™¤)
    â””â”€â”€ admin.sales.order.export  type=action   (åŠŸèƒ½æŒ‰éˆ• - åŒ¯å‡º)
```

**èªªæ˜ï¼š**
- `admin.sales.order.list` æ˜¯ `menu` é¡å‹ï¼Œæœƒé¡¯ç¤ºåœ¨é¸å–®ä¸­ï¼Œé»æ“Šå¾Œé€²å…¥åˆ—è¡¨é 
- `create`ã€`edit`ã€`delete`ã€`export` æ˜¯ `action` é¡å‹ï¼Œä¸é¡¯ç¤ºåœ¨é¸å–®ï¼Œä½†æ§åˆ¶åˆ—è¡¨é å…§çš„æŒ‰éˆ•æ¬Šé™

---

## æ¬Šé™å‘½åè¦å‰‡

ä½¿ç”¨ `.` åˆ†æ®µï¼Œæ ¼å¼ï¼š`{ç³»çµ±}.{æ¨¡çµ„_å­è·¯å¾‘}.{ä½œæ¥­}.{åŠŸèƒ½}`

### ç¬¦è™Ÿè¦å‰‡

| ç¬¦è™Ÿ | ç”¨é€” |
|------|------|
| `.` | å±¤ç´šåˆ†éš”ï¼ˆç³»çµ± â†’ æ¨¡çµ„ â†’ ä½œæ¥­ â†’ åŠŸèƒ½ï¼‰ |
| `_` | åŒå±¤å‘½åçµ„åˆï¼ˆæ¨¡çµ„å­è·¯å¾‘ï¼‰ |

### å‘½åæ…£ä¾‹

| é¡å‹ | æ…£ä¾‹ | ç¯„ä¾‹ | èªªæ˜ |
|------|------|------|------|
| æ¨¡çµ„ | è¤‡æ•¸ | sales, products | å»£ç¾©æ¦‚å¿µ |
| ä½œæ¥­ | å–®æ•¸ | order, product, user | è³‡æºé¡å‹ |

### ç³»çµ±å‰ç¶´

- `pos.*` - POS é»é¤ç³»çµ±
- `admin.*` - å¾Œå°ç®¡ç†ç³»çµ±
- `www.*` - å®˜ç¶²ç³»çµ±

### ç¯„ä¾‹

```
# POS ç³»çµ±
pos.dashboard                       # é¦–é 
pos.order.create                    # å»ºç«‹è¨‚å–®
pos.order.view                      # æŸ¥çœ‹è¨‚å–®
pos.checkout                        # çµå¸³

# å¾Œå° - éŠ·å”®æ¨¡çµ„
admin.sales.order.list              # éŠ·å”® > è¨‚å–®ä½œæ¥­ > åˆ—è¡¨
admin.sales.order.edit              # éŠ·å”® > è¨‚å–®ä½œæ¥­ > ç·¨è¼¯
admin.sales.order.export            # éŠ·å”® > è¨‚å–®ä½œæ¥­ > åŒ¯å‡º [action]
admin.sales.report.daily            # éŠ·å”® > å ±è¡¨ä½œæ¥­ > æ—¥å ±

# å¾Œå° - ç”Ÿç”¢æ¨¡çµ„ / åŸºæœ¬è³‡æ–™
admin.production_basic.product.list # ç”Ÿç”¢ > åŸºæœ¬è³‡æ–™ > å•†å“ä½œæ¥­ > åˆ—è¡¨
admin.production_basic.product.edit # ç”Ÿç”¢ > åŸºæœ¬è³‡æ–™ > å•†å“ä½œæ¥­ > ç·¨è¼¯
admin.production_basic.unit.list    # ç”Ÿç”¢ > åŸºæœ¬è³‡æ–™ > å–®ä½ä½œæ¥­ > åˆ—è¡¨

# å¾Œå° - ç³»çµ±æ¨¡çµ„ / å­˜å–æ§åˆ¶
admin.system_access.user.list       # ç³»çµ± > å­˜å–æ§åˆ¶ > ä½¿ç”¨è€…ä½œæ¥­ > åˆ—è¡¨
admin.system_access.user.edit       # ç³»çµ± > å­˜å–æ§åˆ¶ > ä½¿ç”¨è€…ä½œæ¥­ > ç·¨è¼¯
admin.system_access.role.list       # ç³»çµ± > å­˜å–æ§åˆ¶ > è§’è‰²ä½œæ¥­ > åˆ—è¡¨
admin.system_access.permission.list # ç³»çµ± > å­˜å–æ§åˆ¶ > æ¬Šé™ä½œæ¥­ > åˆ—è¡¨

# æ¬„ä½ç´šæ¬Šé™ï¼ˆæœªä¾†æ“´å……ï¼‰
admin.sales.order.list.cost         # å¯çœ‹æˆæœ¬æ¬„ä½
admin.sales.order.list.profit       # å¯çœ‹æ¯›åˆ©æ¬„ä½
```

---

## é¸å–®é¡¯ç¤ºæ©Ÿåˆ¶

### æ ¸å¿ƒåŸå‰‡

1. **é å…ˆå®šç¾©é¸å–®**ï¼šæ‰€æœ‰é¸å–®é …ç›®éƒ½é å…ˆåœ¨ `permissions` è¡¨ä¸­å®šç¾©ï¼ˆ`type=menu`ï¼‰
2. **å¤šè§’è‰²æ¬Šé™åˆä½µ**ï¼šä½¿ç”¨è€…çš„æ¬Šé™ = æ‰€æœ‰è§’è‰²æ¬Šé™çš„**è¯é›†**
3. **æ¨¹ç‹€éæ¿¾**ï¼šåªé¡¯ç¤ºä½¿ç”¨è€…æœ‰æ¬Šé™çš„é¸å–®é …ç›®
4. **çˆ¶å±¤æª¢æŸ¥**ï¼š**çˆ¶å±¤ç„¡æ¬Šé™ï¼Œæ‰€æœ‰å­å±¤å…¨éƒ¨ä¸é¡¯ç¤º**

### é‹ä½œé‚è¼¯

```php
// 1. å–å¾—ç”¨æˆ¶æ‰€æœ‰è§’è‰²çš„æ¬Šé™ï¼ˆåˆä½µå»é‡ï¼‰
$userPermissions = $user->roles->flatMap->permissions->pluck('name');

// 2. å–å¾—æ‰€æœ‰ type=menu çš„æ¬Šé™
$allMenus = Permission::where('type', 'menu')
    ->where('name', 'like', 'admin.%')  // ç‰¹å®šç³»çµ±
    ->orderBy('sort_order')
    ->get();

// 3. éæ¿¾ï¼šåªé¡¯ç¤ºæœ‰æ¬Šé™çš„é¸å–®ï¼ˆå«çˆ¶å±¤æª¢æŸ¥ï¼‰
$visibleMenus = $allMenus->filter(function($menu) use ($userPermissions) {
    // è‡ªå·±å¿…é ˆæœ‰æ¬Šé™
    if (!$userPermissions->contains($menu->name)) {
        return false;
    }

    // æª¢æŸ¥æ‰€æœ‰ç¥–å…ˆä¹Ÿå¿…é ˆæœ‰æ¬Šé™
    foreach ($menu->ancestors() as $ancestor) {
        if (!$userPermissions->contains($ancestor->name)) {
            return false; // çˆ¶å±¤ç„¡æ¬Šé™ï¼Œä¸é¡¯ç¤º
        }
    }

    return true;
});

// 4. å»ºç«‹æ¨¹ç‹€çµæ§‹æ¸²æŸ“
$menuTree = buildTree($visibleMenus);
```

### ç¯„ä¾‹

```
æ¬Šé™è¨­å®šï¼š
- admin.sales (éŠ·å”®æ¨¡çµ„)
- admin.sales.order (è¨‚å–®ä½œæ¥­)
- admin.sales.order.list (åˆ—è¡¨)

æƒ…æ³ 1ï¼šå®Œæ•´æ¬Šé™
ç”¨æˆ¶æ¬Šé™ï¼š['admin.sales', 'admin.sales.order', 'admin.sales.order.list']
é¡¯ç¤ºçµæœï¼š
âœ… admin.sales (éŠ·å”®æ¨¡çµ„)
  âœ… admin.sales.order (è¨‚å–®ä½œæ¥­)
    âœ… admin.sales.order.list (åˆ—è¡¨)

æƒ…æ³ 2ï¼šç¼ºå°‘çˆ¶å±¤
ç”¨æˆ¶æ¬Šé™ï¼š['admin.sales.order.list'] (ç¼ºå°‘ admin.sales å’Œ admin.sales.order)
é¡¯ç¤ºçµæœï¼š
âŒ admin.sales (ç„¡æ¬Šé™ï¼Œä¸é¡¯ç¤º)
  âŒ admin.sales.order (ç¥–çˆ¶å±¤ç„¡æ¬Šé™ï¼Œä¸é¡¯ç¤º)
    âŒ admin.sales.order.list (ç¥–çˆ¶å±¤ç„¡æ¬Šé™ï¼Œä¸é¡¯ç¤º)

æƒ…æ³ 3ï¼šéƒ¨åˆ†æ¬Šé™
ç”¨æˆ¶æ¬Šé™ï¼š['admin.sales', 'admin.sales.order', 'admin.sales.order.list', 'admin.sales.order.edit']
ä½†ç¼ºå°‘ï¼š['admin.sales.report']
é¡¯ç¤ºçµæœï¼š
âœ… admin.sales (éŠ·å”®æ¨¡çµ„)
  âœ… admin.sales.order (è¨‚å–®ä½œæ¥­)
    âœ… admin.sales.order.list (åˆ—è¡¨)
    âœ… admin.sales.order.edit (ç·¨è¼¯)
  âŒ admin.sales.report (ç„¡æ¬Šé™ï¼Œä¸é¡¯ç¤º)
```

---

## å¯¦éš›è³‡æ–™ç¯„ä¾‹

### æ¬Šé™è³‡æ–™ï¼ˆpermissionsï¼‰

```sql
INSERT INTO permissions (id, parent_id, name, title, type, sort_order, icon) VALUES
-- Admin ç³»çµ±
(1,  NULL, 'admin',                   'å¾Œå°ç®¡ç†', 'menu', 1, 'fas fa-cog'),
(2,  1,    'admin.dashboard',         'é¦–é ',     'menu', 1, 'fas fa-home'),
(3,  1,    'admin.sales',             'éŠ·å”®',     'menu', 2, 'fas fa-shopping-cart'),
(4,  3,    'admin.sales.order',       'è¨‚å–®ä½œæ¥­', 'menu', 1, 'fas fa-file-invoice'),
(5,  4,    'admin.sales.order.list',  'è¨‚å–®åˆ—è¡¨', 'menu', 1, 'fas fa-list'),
(6,  NULL, 'admin.sales.order.create','æ–°å¢è¨‚å–®', 'action', 0, NULL),
(7,  NULL, 'admin.sales.order.edit',  'ç·¨è¼¯è¨‚å–®', 'action', 0, NULL),
(8,  NULL, 'admin.sales.order.delete','åˆªé™¤è¨‚å–®', 'action', 0, NULL),
(9,  NULL, 'admin.sales.order.export','åŒ¯å‡ºè¨‚å–®', 'action', 0, NULL),

-- POS ç³»çµ±
(10, NULL, 'pos',                     'POSç³»çµ±',  'menu', 1, 'fas fa-cash-register'),
(11, 10,   'pos.dashboard',           'é¦–é ',     'menu', 1, 'fas fa-home'),
(12, 10,   'pos.order',               'é»é¤',     'menu', 2, 'fas fa-utensils'),
(13, NULL, 'pos.order.create',        'å»ºç«‹è¨‚å–®', 'action', 0, NULL),
(14, NULL, 'pos.order.view',          'æŸ¥çœ‹è¨‚å–®', 'action', 0, NULL),
(15, 10,   'pos.checkout',            'çµå¸³',     'menu', 3, 'fas fa-money-bill');
```

---

### è§’è‰²è³‡æ–™ï¼ˆrolesï¼‰

```sql
INSERT INTO roles (id, name, title, description) VALUES
(1, 'super_admin',   'è¶…ç´šç®¡ç†å“¡', 'æ“æœ‰æ‰€æœ‰æ¬Šé™'),
(2, 'sales_manager', 'éŠ·å”®ç¶“ç†',   'å¯ç®¡ç†è¨‚å–®ï¼Œå¯æ–°å¢ã€ç·¨è¼¯'),
(3, 'sales_staff',   'éŠ·å”®äººå“¡',   'åªèƒ½æŸ¥çœ‹è¨‚å–®'),
(4, 'pos_staff',     'POSäººå“¡',    'é–€å¸‚é»é¤äººå“¡');
```

---

### è§’è‰²æ¬Šé™åˆ†é…ï¼ˆrole_has_permissionsï¼‰

```sql
-- è¶…ç´šç®¡ç†å“¡ï¼šæ‰€æœ‰æ¬Šé™
INSERT INTO role_has_permissions (role_id, permission_id) VALUES
(1, 1), (1, 2), (1, 3), (1, 4), (1, 5), (1, 6), (1, 7), (1, 8), (1, 9),
(1, 10), (1, 11), (1, 12), (1, 13), (1, 14), (1, 15);

-- éŠ·å”®ç¶“ç†ï¼šå¯ä»¥æŸ¥çœ‹ã€æ–°å¢ã€ç·¨è¼¯ï¼ˆç¼ºå°‘åˆªé™¤ã€åŒ¯å‡ºï¼‰
INSERT INTO role_has_permissions (role_id, permission_id) VALUES
(2, 1),  -- admin
(2, 2),  -- admin.dashboard
(2, 3),  -- admin.sales
(2, 4),  -- admin.sales.order
(2, 5),  -- admin.sales.order.list
(2, 6),  -- admin.sales.order.create
(2, 7);  -- admin.sales.order.edit
-- ç¼ºå°‘ 8 (delete), 9 (export)

-- éŠ·å”®äººå“¡ï¼šåªèƒ½æŸ¥çœ‹
INSERT INTO role_has_permissions (role_id, permission_id) VALUES
(3, 1),  -- admin
(3, 2),  -- admin.dashboard
(3, 3),  -- admin.sales
(3, 4),  -- admin.sales.order
(3, 5);  -- admin.sales.order.list
-- ç¼ºå°‘æ‰€æœ‰ action (6, 7, 8, 9)

-- POSäººå“¡ï¼šPOS ç³»çµ±æ¬Šé™
INSERT INTO role_has_permissions (role_id, permission_id) VALUES
(4, 10), -- pos
(4, 11), -- pos.dashboard
(4, 12), -- pos.order
(4, 13), -- pos.order.create
(4, 14), -- pos.order.view
(4, 15); -- pos.checkout
```

---

### ä½¿ç”¨è€…è§’è‰²åˆ†é…ï¼ˆmodel_has_rolesï¼‰

```sql
-- ä½¿ç”¨è€… 1ï¼šåŒæ™‚æ˜¯éŠ·å”®ç¶“ç†å’ŒéŠ·å”®äººå“¡ï¼ˆå¤šè§’è‰²ï¼‰
INSERT INTO model_has_roles (role_id, model_type, model_id) VALUES
(2, 'App\\Models\\SystemUser', 1),  -- éŠ·å”®ç¶“ç†
(3, 'App\\Models\\SystemUser', 1);  -- éŠ·å”®äººå“¡

-- ä½¿ç”¨è€… 2ï¼šé–€å¸‚ç¶“ç†ï¼ˆåŒæ™‚æœ‰ POS å’Œéƒ¨åˆ† Admin æ¬Šé™ï¼‰
INSERT INTO model_has_roles (role_id, model_type, model_id) VALUES
(4, 'App\\Models\\SystemUser', 2),  -- POSäººå“¡
(3, 'App\\Models\\SystemUser', 2);  -- éŠ·å”®äººå“¡ï¼ˆå¯æŸ¥çœ‹è¨‚å–®ï¼‰
```

---

### æ¬Šé™è¨ˆç®—çµæœ

#### ä½¿ç”¨è€… 1ï¼ˆéŠ·å”®ç¶“ç† + éŠ·å”®äººå“¡ï¼‰

```php
$user = SystemUser::find(1);
$roles = $user->roles;
// çµæœï¼š[sales_manager, sales_staff]

$allPermissions = $roles->flatMap->permissions->pluck('name')->unique();
// çµæœï¼ˆè¯é›†ï¼‰ï¼š
// Menu: admin, admin.dashboard, admin.sales, admin.sales.order, admin.sales.order.list
// Action: admin.sales.order.create, admin.sales.order.edit

// Admin é¸å–®é¡¯ç¤ºï¼š
âœ… å¾Œå°ç®¡ç†
  âœ… é¦–é 
  âœ… éŠ·å”®
    âœ… è¨‚å–®ä½œæ¥­
      âœ… è¨‚å–®åˆ—è¡¨  â† å¯é€²å…¥

// åœ¨è¨‚å–®åˆ—è¡¨é é¢ï¼š
âœ… æ–°å¢æŒ‰éˆ•ï¼ˆæœ‰ create æ¬Šé™ï¼‰
âœ… ç·¨è¼¯æŒ‰éˆ•ï¼ˆæœ‰ edit æ¬Šé™ï¼‰
âŒ åˆªé™¤æŒ‰éˆ•ï¼ˆæ²’æœ‰ delete æ¬Šé™ï¼‰
âŒ åŒ¯å‡ºæŒ‰éˆ•ï¼ˆæ²’æœ‰ export æ¬Šé™ï¼‰

// POS é¸å–®ï¼š
âŒ ç„¡ä»»ä½• POS æ¬Šé™ï¼Œä¸é¡¯ç¤ºé¸å–®
```

#### ä½¿ç”¨è€… 2ï¼ˆé–€å¸‚ç¶“ç†ï¼šPOSäººå“¡ + éŠ·å”®äººå“¡ï¼‰

```php
$user = SystemUser::find(2);
$roles = $user->roles;
// çµæœï¼š[pos_staff, sales_staff]

$allPermissions = $roles->flatMap->permissions->pluck('name')->unique();
// çµæœï¼ˆè¯é›†ï¼‰ï¼š
// POS Menu: pos, pos.dashboard, pos.order, pos.checkout
// POS Action: pos.order.create, pos.order.view
// Admin Menu: admin, admin.dashboard, admin.sales, admin.sales.order, admin.sales.order.list
// Admin Action: (ç„¡)

// POS å‰ç«¯é¸å–®é¡¯ç¤ºï¼š
âœ… POSç³»çµ±
  âœ… é¦–é 
  âœ… é»é¤
  âœ… çµå¸³

// Admin å¾Œå°é¸å–®é¡¯ç¤ºï¼š
âœ… å¾Œå°ç®¡ç†
  âœ… é¦–é 
  âœ… éŠ·å”®
    âœ… è¨‚å–®ä½œæ¥­
      âœ… è¨‚å–®åˆ—è¡¨  â† åªèƒ½æŸ¥çœ‹

// åœ¨è¨‚å–®åˆ—è¡¨é é¢ï¼š
âŒ æ–°å¢æŒ‰éˆ•ï¼ˆæ²’æœ‰ create æ¬Šé™ï¼‰
âŒ ç·¨è¼¯æŒ‰éˆ•ï¼ˆæ²’æœ‰ edit æ¬Šé™ï¼‰
âŒ åˆªé™¤æŒ‰éˆ•ï¼ˆæ²’æœ‰ delete æ¬Šé™ï¼‰
```

---

## æ¬Šé™åˆ¤æ–·æµç¨‹

### å¾Œå°é¸å–®æ¸²æŸ“

```php
// 1. å–å¾—ä½¿ç”¨è€…æ‰€æœ‰è§’è‰²çš„æ¬Šé™ï¼ˆåˆä½µå»é‡ï¼‰
$userPermissions = $user->roles->flatMap->permissions->pluck('name');

// 2. å–å¾—æ‰€æœ‰ type=menu ä¸”å‰ç¶´ç‚º admin çš„æ¬Šé™
$allMenus = Permission::where('type', 'menu')
    ->where('name', 'like', 'admin.%')
    ->orderBy('sort_order')
    ->get();

// 3. éæ¿¾ï¼šåªé¡¯ç¤ºæœ‰æ¬Šé™çš„é¸å–®ï¼ˆå«çˆ¶å±¤æª¢æŸ¥ï¼‰
$visibleMenus = $allMenus->filter(function($menu) use ($userPermissions) {
    // è‡ªå·±å¿…é ˆæœ‰æ¬Šé™
    if (!$userPermissions->contains($menu->name)) {
        return false;
    }

    // æª¢æŸ¥æ‰€æœ‰ç¥–å…ˆä¹Ÿå¿…é ˆæœ‰æ¬Šé™
    foreach ($menu->ancestors() as $ancestor) {
        if (!$userPermissions->contains($ancestor->name)) {
            return false;
        }
    }

    return true;
});

// 4. å»ºç«‹æ¨¹ç‹€çµæ§‹æ¸²æŸ“
$menuTree = buildMenuTree($visibleMenus);
```

---

### POS å‰ç«¯ API

```json
GET /api/pos/v2/user/permissions

{
  "permissions": [
    "pos.dashboard",
    "pos.order.create",
    "pos.order.view",
    "pos.checkout"
  ],
  "menus": [...]
}
```

å‰ç«¯æ ¹æ“šå›å‚³çš„æ¬Šé™é™£åˆ—æ±ºå®šé¡¯ç¤ºå“ªäº›é¸å–®èˆ‡åŠŸèƒ½æŒ‰éˆ•ã€‚

---

## è§’è‰²æ¬Šé™åˆ†é…å»ºè­°

### âš ï¸ é‡è¦ï¼šå¿…é ˆåˆ†é…å®Œæ•´è·¯å¾‘çš„æ¬Šé™

```sql
-- âŒ éŒ¯èª¤åšæ³•ï¼šåªåˆ†é…æœ€åº•å±¤
INSERT INTO role_has_permissions (role_id, permission_id) VALUES
(3, 5);  -- åªçµ¦ admin.sales.order.list

-- çµæœï¼šçœ‹ä¸åˆ°é¸å–®ï¼
-- å› ç‚ºç¼ºå°‘ï¼šadmin (1), admin.sales (3), admin.sales.order (4)
```

```sql
-- âœ… æ­£ç¢ºåšæ³•ï¼šåˆ†é…å®Œæ•´è·¯å¾‘
INSERT INTO role_has_permissions (role_id, permission_id) VALUES
(3, 1),  -- admin
(3, 3),  -- admin.sales
(3, 4),  -- admin.sales.order
(3, 5);  -- admin.sales.order.list

-- çµæœï¼šå¯ä»¥çœ‹åˆ°å®Œæ•´é¸å–®è·¯å¾‘
```

---

### ğŸ’¡ å»ºè­°ï¼šè‡ªå‹•åˆ†é…çˆ¶å±¤æ¬Šé™

```php
// app/Models/Access/Role.php

/**
 * åˆ†é…æ¬Šé™æ™‚è‡ªå‹•åˆ†é…æ‰€æœ‰çˆ¶å±¤æ¬Šé™
 */
public function assignPermissionWithAncestors(Permission $permission)
{
    // åˆ†é…æ¬Šé™æœ¬èº«
    if (!$this->hasPermissionTo($permission)) {
        $this->givePermissionTo($permission);
    }

    // è‡ªå‹•åˆ†é…æ‰€æœ‰çˆ¶å±¤æ¬Šé™
    foreach ($permission->ancestors() as $ancestor) {
        if (!$this->hasPermissionTo($ancestor)) {
            $this->givePermissionTo($ancestor);
        }
    }
}

// ä½¿ç”¨
$role = Role::find(3);
$permission = Permission::where('name', 'admin.sales.order.list')->first();
$role->assignPermissionWithAncestors($permission);
// è‡ªå‹•åˆ†é…ï¼šadmin, admin.sales, admin.sales.order, admin.sales.order.list
```

---

## æ¬Šé™æª¢æŸ¥æ–¹å¼

### Blade è¦–åœ–

```blade
@can('admin.sales.order.create')
    <button>æ–°å¢è¨‚å–®</button>
@endcan

@can('admin.sales.order.edit')
    <button>ç·¨è¼¯</button>
@endcan

@can('admin.sales.order.delete')
    <button>åˆªé™¤</button>
@endcan
```

---

### Controller

```php
public function create()
{
    $this->authorize('admin.sales.order.create');
    // ...
}

public function export()
{
    $this->authorize('admin.sales.order.export');
    // ...
}
```

---

### Middleware

```php
Route::get('/orders/export', [OrderController::class, 'export'])
    ->middleware('can:admin.sales.order.export');
```

---

### API æª¢æŸ¥

```php
// POS API
public function createOrder(Request $request)
{
    if (!$request->user()->can('pos.order.create')) {
        return response()->json(['error' => 'Forbidden'], 403);
    }

    // ...
}
```

---

## é—œè¯èªªæ˜

```
SystemUser (ä½¿ç”¨è€…)
  â””â”€â”€ model_has_roles â†’ Role (è§’è‰²)
                         â””â”€â”€ role_has_permissions â†’ Permission (æ¬Šé™)

Permission (æ¬Šé™)
  â””â”€â”€ belongsTo â†’ Permission (parent_id è‡ªé—œè¯ï¼Œæ¨¹ç‹€çµæ§‹)
```

**è³‡æ–™æµå‘ï¼š**
```
ä½¿ç”¨è€… â†’ å¤šå€‹è§’è‰² â†’ å¤šå€‹æ¬Šé™ï¼ˆè¯é›†ï¼‰ â†’ éæ¿¾ type=menu â†’ æª¢æŸ¥çˆ¶å±¤ â†’ é¡¯ç¤ºé¸å–®
```

---

## MenuService ä½¿ç”¨æŒ‡å—

æœ¬ç³»çµ±æä¾› `MenuService` æœå‹™é¡åˆ¥ï¼Œå°è£é¸å–®å¿«å–èˆ‡éæ¿¾é‚è¼¯ã€‚

### åŸºæœ¬ä½¿ç”¨

**æª”æ¡ˆä½ç½®**ï¼š`app/Services/MenuService.php`

**æ ¸å¿ƒæ–¹æ³•**ï¼š

```php
// 1. å–å¾—ä½¿ç”¨è€…é¸å–®ï¼ˆå·²éæ¿¾æ¬Šé™ï¼Œå·²å¿«å–ï¼‰
public function getUserMenus(Authenticatable $user, string $system): Collection

// 2. å–å¾—ä½¿ç”¨è€…æ‰€æœ‰æ¬Šé™ï¼ˆå¤šè§’è‰²è¯é›†ï¼‰
public function getUserPermissions(Authenticatable $user): Collection

// 3. å–å¾—éºµåŒ…å±‘è·¯å¾‘
public function getBreadcrumb(string $currentPermissionName, string $system): Collection

// 4. æ¸…é™¤å¿«å–
public function clearGlobalMenuCache(string $system): void
public function clearUserMenuCache(Authenticatable $user, string $system): void
public function clearAllGlobalMenuCache(): void
public function clearAllRoleMenuCache(string $system): void
```

---

### Admin å¾Œå°ç¯„ä¾‹

#### Controller æ³¨å…¥

```php
namespace App\Domains\Admin\Http\Controllers;

use App\Services\MenuService;
use Illuminate\Http\Request;

class DashboardController extends Controller
{
    public function index(MenuService $menuService)
    {
        $user = auth()->user();

        // å–å¾—é¸å–®
        $menus = $menuService->getUserMenus($user, 'admin');

        // å–å¾—éºµåŒ…å±‘
        $breadcrumb = $menuService->getBreadcrumb('admin.dashboard', 'admin');

        return view('admin.dashboard', compact('menus', 'breadcrumb'));
    }
}
```

---

#### Middleware å…¨åŸŸæ³¨å…¥

åœ¨ Middleware ä¸­æ³¨å…¥é¸å–®åˆ°æ‰€æœ‰è¦–åœ–ï¼š

```php
namespace App\Domains\Admin\Http\Middleware;

use App\Services\MenuService;
use Closure;
use Illuminate\Support\Facades\View;

class InjectAdminMenus
{
    protected MenuService $menuService;

    public function __construct(MenuService $menuService)
    {
        $this->menuService = $menuService;
    }

    public function handle($request, Closure $next)
    {
        if (auth()->check()) {
            $menus = $this->menuService->getUserMenus(auth()->user(), 'admin');
            View::share('adminMenus', $menus);
        }

        return $next($request);
    }
}
```

**è¨»å†Š Middleware**ï¼š

```php
// app/Domains/Admin/routes/admin.php
Route::middleware(['auth:admin', InjectAdminMenus::class])->group(function () {
    // Admin è·¯ç”±
});
```

---

#### Blade è¦–åœ–æ¸²æŸ“

```blade
{{-- app/Domains/Admin/Views/admin/layout/sidebar.blade.php --}}

<nav class="sidebar">
    @foreach ($adminMenus as $menu)
        <div class="menu-item">
            <a href="{{ route($menu->name) }}" class="menu-link">
                <i class="{{ $menu->icon }}"></i>
                <span>{{ $menu->title }}</span>
            </a>

            @if ($menu->children && $menu->children->isNotEmpty())
                <ul class="submenu">
                    @foreach ($menu->children as $child)
                        <li>
                            <a href="{{ route($child->name) }}">
                                <i class="{{ $child->icon }}"></i>
                                {{ $child->title }}
                            </a>

                            @if ($child->children && $child->children->isNotEmpty())
                                <ul class="submenu-level-2">
                                    @foreach ($child->children as $grandchild)
                                        <li>
                                            <a href="{{ route($grandchild->name) }}">
                                                {{ $grandchild->title }}
                                            </a>
                                        </li>
                                    @endforeach
                                </ul>
                            @endif
                        </li>
                    @endforeach
                </ul>
            @endif
        </div>
    @endforeach
</nav>
```

---

### POS API ç¯„ä¾‹

#### API Controller

```php
namespace App\Domains\ApiPosV2\Http\Controllers;

use App\Services\MenuService;
use Illuminate\Http\Request;

class AuthController extends Controller
{
    /**
     * ç”¨æˆ¶ç™»å…¥å¾Œå–å¾—æ¬Šé™èˆ‡é¸å–®
     */
    public function permissions(MenuService $menuService)
    {
        $user = auth()->user();

        return response()->json([
            'success' => true,
            'data' => [
                'menus' => $menuService->getUserMenus($user, 'pos'),
                'permissions' => $menuService->getUserPermissions($user)
            ]
        ]);
    }
}
```

---

#### API è·¯ç”±

```php
// app/Domains/ApiPosV2/routes/api.php
Route::middleware('auth:api')->group(function () {
    Route::get('user/permissions', [AuthController::class, 'permissions']);
});
```

---

#### API å›æ‡‰ç¯„ä¾‹

```json
{
  "success": true,
  "data": {
    "menus": [
      {
        "id": 10,
        "name": "pos.dashboard",
        "title": "é¦–é ",
        "icon": "fas fa-home",
        "sort_order": 1,
        "children": []
      },
      {
        "id": 12,
        "name": "pos.order",
        "title": "é»é¤",
        "icon": "fas fa-utensils",
        "sort_order": 2,
        "children": [
          {
            "id": 20,
            "name": "pos.order.list",
            "title": "è¨‚å–®åˆ—è¡¨",
            "icon": "fas fa-list",
            "sort_order": 1
          }
        ]
      },
      {
        "id": 15,
        "name": "pos.checkout",
        "title": "çµå¸³",
        "icon": "fas fa-money-bill",
        "sort_order": 3,
        "children": []
      }
    ],
    "permissions": [
      "pos.dashboard",
      "pos.order",
      "pos.order.list",
      "pos.order.create",
      "pos.order.view",
      "pos.checkout"
    ]
  }
}
```

---

#### å‰ç«¯ä½¿ç”¨ï¼ˆVue.js ç¯„ä¾‹ï¼‰

```javascript
// ç™»å…¥å¾Œå–å¾—é¸å–®èˆ‡æ¬Šé™
async function fetchPermissions() {
  const response = await axios.get('/api/pos/v2/user/permissions');
  const { menus, permissions } = response.data.data;

  // å„²å­˜åˆ° Vuex
  store.commit('setMenus', menus);
  store.commit('setPermissions', permissions);
}

// æª¢æŸ¥æ¬Šé™
function canDo(permission) {
  return store.state.permissions.includes(permission);
}

// åœ¨çµ„ä»¶ä¸­ä½¿ç”¨
<template>
  <div>
    <button v-if="canDo('pos.order.create')" @click="createOrder">
      æ–°å¢è¨‚å–®
    </button>
  </div>
</template>
```

---

### æ‰‹å‹•æ¸…é™¤å¿«å–

åœ¨æŸäº›æƒ…æ³ä¸‹ï¼Œéœ€è¦æ‰‹å‹•æ¸…é™¤å¿«å–ï¼š

#### 1. æ¸…é™¤å…¨åŸŸé¸å–®å¿«å–

```php
use App\Services\MenuService;

$menuService = app(MenuService::class);

// æ¸…é™¤ç‰¹å®šç³»çµ±
$menuService->clearGlobalMenuCache('admin');

// æ¸…é™¤æ‰€æœ‰ç³»çµ±
$menuService->clearAllGlobalMenuCache();
```

**ä½¿ç”¨æ™‚æ©Ÿ**ï¼š
- ä¿®æ”¹ `permissions` è¡¨çš„è³‡æ–™ï¼ˆæ–°å¢ã€ä¿®æ”¹ã€åˆªé™¤é¸å–®é …ç›®ï¼‰
- èª¿æ•´é¸å–®çµæ§‹ã€æ’åºã€åœ–ç¤º

---

#### 2. æ¸…é™¤è§’è‰²é¸å–®å¿«å–

```php
// æ¸…é™¤ç‰¹å®šç”¨æˆ¶çš„é¸å–®å¿«å–
$user = auth()->user();
$menuService->clearUserMenuCache($user, 'admin');

// æ¸…é™¤ç‰¹å®šç³»çµ±çš„æ‰€æœ‰è§’è‰²çµ„åˆå¿«å–
$menuService->clearAllRoleMenuCache('admin');
```

**ä½¿ç”¨æ™‚æ©Ÿ**ï¼š
- èª¿æ•´è§’è‰²æ¬Šé™ï¼ˆ`role_has_permissions` è¡¨ç•°å‹•ï¼‰
- èª¿æ•´ç”¨æˆ¶è§’è‰²ï¼ˆ`model_has_roles` è¡¨ç•°å‹•ï¼‰

---

#### 3. Artisan å‘½ä»¤æ¸…é™¤

```bash
# æ¸…é™¤æ‰€æœ‰å¿«å–
php artisan cache:clear

# ä½¿ç”¨ Tinker æ¸…é™¤ç‰¹å®šå¿«å–
php artisan tinker
>>> app(\App\Services\MenuService::class)->clearAllGlobalMenuCache();
>>> app(\App\Services\MenuService::class)->clearAllRoleMenuCache('admin');
```

---

#### 4. ç®¡ç†å¾Œå°æ¸…é™¤

å»ºç«‹ç®¡ç†ä»‹é¢æŒ‰éˆ•æ¸…é™¤å¿«å–ï¼š

```php
// Admin Controller
public function clearMenuCache(MenuService $menuService)
{
    $this->authorize('admin.system.cache.clear');

    $menuService->clearAllGlobalMenuCache();

    $systems = ['admin', 'pos', 'www'];
    foreach ($systems as $system) {
        $menuService->clearAllRoleMenuCache($system);
    }

    return redirect()->back()->with('success', 'é¸å–®å¿«å–å·²æ¸…é™¤');
}
```

---

## æœªä¾†æ“´å……

### æ¬„ä½ç´šæ¬Šé™

é€éæ›´ç´°çš„ name åˆ†æ®µå¯¦ç¾ï¼š

```
admin.sales.order.list           # å¯é€²å…¥è¨‚å–®åˆ—è¡¨é 
admin.sales.order.list.cost      # å¯çœ‹æˆæœ¬æ¬„ä½
admin.sales.order.list.profit    # å¯çœ‹æ¯›åˆ©æ¬„ä½
admin.sales.order.edit.price     # å¯ä¿®æ”¹åƒ¹æ ¼
```

### è³‡æ–™ç¯„åœæ¬Šé™

å¯å¢åŠ  `scope` æ¬„ä½æ§åˆ¶è³‡æ–™ç¯„åœï¼š

- `all` - æ‰€æœ‰è³‡æ–™
- `store` - åƒ…é™æ‰€å±¬é–€å¸‚
- `self` - åƒ…é™è‡ªå·±å»ºç«‹çš„

### Redis Tags æ”¯æ´

å•Ÿç”¨ Redis Tags åŠŸèƒ½ï¼Œæ›´æ–¹ä¾¿ç®¡ç†å¿«å–ç¾¤çµ„ï¼š

```php
// å„²å­˜æ™‚åŠ ä¸Š Tags
Cache::tags(['menu', $system])
    ->remember($cacheKey, $ttl, function() {
        // ...
    });

// æ¸…é™¤æ™‚ä½¿ç”¨ Tags
Cache::tags(['menu', 'admin'])->flush(); // æ¸…é™¤æ‰€æœ‰ admin é¸å–®å¿«å–
Cache::tags(['menu'])->flush();          // æ¸…é™¤æ‰€æœ‰é¸å–®å¿«å–
```

---

**æ–‡ä»¶ç‰ˆæœ¬**: 3.0
**æœ€å¾Œæ›´æ–°**: 2025-11-25
**ç¶­è­·åœ˜éšŠ**: Development Team
